events { }


http {
    proxy_buffers 32 160k;  
    proxy_buffer_size 160k;
    proxy_read_timeout 3600;
    error_log /dev/stdout info;
    access_log /dev/stdout;

    server {
        listen ${NGINX_DEFAULT_PORT} ssl default_server;

        chunked_transfer_encoding on;

        ssl_certificate        server.crt;
        ssl_certificate_key    private_key.pem; 

        #if_tag ${NGING_BLOB_MODULE_NAME_ADDRESS}
        if ($http_x_ms_blob_type = BlockBlob)
        {
            rewrite ^(.*)$ /storage$1 last;
        } 
        #endif_tag ${NGING_BLOB_MODULE_NAME_ADDRESS}

        #if_tag !${NGING_REGISTRY_MODULE_ADDRESS}
        location /v2 {
            proxy_http_version 1.1;
            resolver 127.0.0.11;
            set $backend "http://${IOTEDGE_GATEWAYHOSTNAME}";
            proxy_pass          $backend;
        }
       #endif_tag !${NGING_REGISTRY_MODULE_ADDRESS}

        #if_tag ${NGING_REGISTRY_MODULE_ADDRESS}
        location /v2 {
            proxy_http_version 1.1;
            resolver 127.0.0.11;
            set $backend "http://${NGING_REGISTRY_MODULE_ADDRESS}";
            proxy_pass          $backend;
        }
       #endif_tag ${NGING_REGISTRY_MODULE_ADDRESS}

        #if_tag ${NGING_BLOB_MODULE_NAME_ADDRESS}
        location ~^/storage/(.*){
            proxy_http_version 1.1;
            resolver 127.0.0.11;
            set $backend "http://${NGING_BLOB_MODULE_NAME_ADDRESS}";
            proxy_pass          $backend/$1$is_args$args;
        }
        #endif_tag ${NGING_BLOB_MODULE_NAME_ADDRESS}

        #if_tag ${NGINX_NOT_ROOT}      
        location /{
            proxy_http_version 1.1;
            resolver 127.0.0.11;
            set $backend "https://${GATEWAY_HOSTNAME}:443";
            proxy_pass          $backend/$1$is_args$args;
        }
        #endif_tag ${NGINX_NOT_ROOT}
    }
}