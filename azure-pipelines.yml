resources:
  repositories:
  - repository: iotedge # The name used to reference this repository in the checkout step
    type: github
    endpoint: azure-iot-edge-iotedge1-github
    name: azure/iotedge
  - repository: azure-iotedge
    type: github
    endpoint: azure-iot-edge-iotedge1-github
    name: azure/azure-iotedge
  - repository: iot-identity-service
    type: github
    endpoint: azure-iot-edge-iotedge1-github
    name: azure/iot-identity-service

trigger:
- main

stages:
  - stage: TestStage
    displayName: Stage 1
    pool:
      name: 'Azure-IoT-Edge-1ES-Hosted-Linux'
      demands:
        - ImageOverride -equals agent-aziotedge-ubuntu-20.04-docker
    jobs:
    - job: job1
      displayName: job1
      steps:
      - checkout: self
        submodules: recursive
      - checkout: iotedge
        submodules: recursive
      - checkout: azure-iotedge
        submodules: recursive
      - checkout: iot-identity-service
        submodules: recursive
      - task: Bash@3
        displayName: Directory layout
        inputs:
          targetType: 'inline'
          script: |
            echo "=============================================="
            echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
            ls -a $(Build.SourcesDirectory)
            # find $(Build.SourcesDirectory) -type d | sed -e "s/[^-][^\/]*\// |/g" -e "s/|\([^ ]\)/|-\1/"
            # ls -R $(Build.SourcesDirectory) | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
            echo " "
            echo "=============================================="
            echo "Agent.BuildDirectory:   $(Agent.BuildDirectory)"
            ls -a $(Agent.BuildDirectory)
            # find $(Agent.BuildDirectory) -type d | sed -e "s/[^-][^\/]*\// |/g" -e "s/|\([^ ]\)/|-\1/"
            # ls -R $(Agent.BuildDirectory) | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'
      - task: Bash@3
        displayName: Test GitHub
        inputs:
          targetType: 'inline'
          script: |
            echo "=============================================="

            # echo "git config --global user.name IotEdge1"
            # git config --global user.name "IotEdge1"

            # echo "git config --global user.email \"iotedge1@microsoft.com\""
            # git config --global user.email "iotedge1@microsoft.com"

            # git push https://<GITHUB_ACCESS_TOKEN>@github.com/<GITHUB_USERNAME>/<REPOSITORY_NAME>.git

            echo "cd $(Build.SourcesDirectory)/iotedge"
            cd $(Build.SourcesDirectory)/iotedge

            gitCmd="git remote -vv"
            echo "$gitCmd"
            $gitCmd || true

            gitCmd="git branch -vv"
            echo "$gitCmd"
            $gitCmd || true

            gitCmd="git branch -b yophilav/TestGhCli"
            echo "$gitCmd"
            $gitCmd || true