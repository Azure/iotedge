trigger: none
pr:
  branches:
    include:
      - master
      - release/*
      - iiot
jobs:

  ################################################################################
  - job: check_run_pipeline
    ################################################################################
    displayName: Check pipeline preconditions (changes ARE in builds or edge hub)
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - bash: |
          git log -m -1 --name-only --first-parent --pretty="" | egrep -i '^(builds|edge-hub)'
          if [[ $? == 0 ]]; then
            echo "Detected changes inside builds or edgehub folders"
            echo "##vso[task.setvariable variable=RUN_PIPELINE;isOutput=true]TRUE"
          fi
        displayName: Check changes in sources
        name: check_files

  ################################################################################
  - job: linux_amd64
    ################################################################################
    displayName: Linux amd64
    dependsOn: check_run_pipeline
    condition: eq(dependencies.check_run_pipeline.outputs['check_files.RUN_PIPELINE'], 'true')
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - script: echo "##vso[task.setvariable variable=RUST_BACKTRACE;]1"
        displayName: Set env variables
      - bash: mqtt/build/linux/install.sh
        displayName: Install Rust
      - bash: scripts/linux/generic-rust-build.sh --build-target watchdog
        displayName: Build
      - bash: mqtt/build/linux/test.sh
        displayName: Test

  ################################################################################
  - job: style_check
    ################################################################################
    displayName: Style Check
    dependsOn: check_run_pipeline
    condition: eq(dependencies.check_run_pipeline.outputs['check_files.RUN_PIPELINE'], 'true')
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - bash: mqtt/build/linux/install.sh
        displayName: Install Rust
      - bash: mqtt/build/linux/format.sh
        displayName: Format Code
      - bash: mqtt/build/linux/clippy.sh
        displayName: Clippy
