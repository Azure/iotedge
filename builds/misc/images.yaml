trigger:
  batch: true
  branches:
    include:
      - master
      - release/*
pr: none

variables:
  NugetSecurityAnalysisWarningLevel: warn

stages:
- stage: BuildExecutables
  pool:
    name: $(pool.linux.name)
    demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker  
  dependsOn: []
  jobs:
  - job: DockerLogin
    displayName: Docker login edgebuilds
    steps:
    - task: Docker@2
      inputs:
        command: login
        containerRegistry: iotedge-edgebuilds-acr
  - job: BuildDotnetComponents
    displayName: Build Dotnet Components
    steps:
    - script: scripts/linux/buildBranch.sh -c $(Build.Configuration) --no-rocksdb-bin
      name: build
      displayName: Build ($(Build.Configuration)) dotnet artifacts
    - task: PublishPipelineArtifact@1
      displayName: Publish Dotnet Artifacts
      inputs:
        targetPath: '$(Build.BinariesDirectory)/publish'
        artifactName: 'dotnet_artifacts'
        artifactType: 'pipeline'
  - template: templates/build-broker-watchdog.yaml
- stage: PublishEdgeHubArtifacts
  pool:
    name: $(pool.linux.name)
    demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker  
  dependsOn: BuildExecutables
  jobs:
  - job: ConsolidateEdgeHubArtifacts
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        source: 'current'
        path: '$(Build.ArtifactStagingDirectory)'
    - task: CopyFiles@2
      inputs:
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'
        contents: 'mqttd_amd64/mqttd'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/mqtt/target/x86_64-unknown-linux-musl/release'        
    - task: CopyFiles@2
      inputs:  
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'        
        contents: 'mqttd_arm32/mqttd'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/mqtt/target/armv7-unknown-linux-gnueabihf/release'
    - task: CopyFiles@2
      inputs:    
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'              
        contents: 'mqttd_arm64/mqttd'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/mqtt/target/aarch64-unknown-linux-gnu/release'
    - task: CopyFiles@2
      inputs:
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'              
        contents: 'watchdog_amd64/watchdog'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/edge-hub/watchdog/target/x86_64-unknown-linux-musl/release'
    - task: CopyFiles@2
      inputs:
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'              
        contents: 'watchdog_arm32/watchdog'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/edge-hub/watchdog/target/armv7-unknown-linux-gnueabihf/release'
    - task: CopyFiles@2
      inputs:
        sourceFolder: '$(Build.ArtifactsStagingDirectory)'              
        contents: 'watchdog_arm64/watchdog'
        targetFolder: '$(Build.ArtifactsStagingDirectory)/edge-hub/watchdog/target/aarch64-unknown-linux-gnu/release'                             
    - script: scripts/linux/consolidate-build-artifacts.sh --dotnet-artifacts-source-dir '$(Build.ArtifactStagingDirectory/dotnet_artifacts' --rust-artifacts-source-dir '$(Build.ArtifactsStagingDirectory' --target-dir '$(Build.BinariesDirectory)' --artifact-name 'edge-hub'
      displayName: Consolidate Edge Hub Artifacts
    - script: scripts/linux/createArtifactInfo.sh --output-folder '$(Build.BinariesDirectory)/publish' --build-number $(Build.BuildNumber)
      displayName: 'Create Artifact Info File'      
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifacts'
      inputs:
        targetPath: '$(Build.BinariesDirectory)/publish'
        artifactName: 'core-linux'
        artifactType: 'pipeline'      
- stage:  BuildImages
  pool:
    name: $(pool.linux.name)
    demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
  dependsOn: PublishBuildArtifacts
  jobs:
  - task: DownloadPipelineArtifact@2
    inputs:
      source: 'current'
      path: '$(Build.ArtifactStagingDirectory)'
  - task: CopyFiles@2
    inputs:
      sourceFolder: '$(Build.ArtifactsStagingDirectory)'
      contents: 'core-linux/**'
      targetFolder: '$(Build.BinariesDirectory)'
  # Edge Agent
  - template: templates/image-linux.yaml
    parameters:
      name: Edge Agent
      imageName: azureiotedge-agent
      project: Microsoft.Azure.Devices.Edge.Agent.Service

  # Edge Hub
  - template: templates/image-linux.yaml
    parameters:
      name: Edge Hub
      imageName: azureiotedge-hub
      project: edge-hub

  # Simulated Temperature Sensor
  - template: templates/image-linux.yaml
    parameters:
      name: Temperature Sensor
      imageName: azureiotedge-simulated-temperature-sensor
      project: SimulatedTemperatureSensor      


# jobs:
# ################################################################################
#   - job: linux_dotnet_projects
# ################################################################################
#     timeoutInMinutes: 180
#     displayName: LinuxDotnet
#     pool:
#       name: $(pool.linux.name)
#       demands:
#         - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
#     steps:
#       - task: Docker@2
#         displayName: Docker login edgebuilds
#         inputs:
#           command: login
#           containerRegistry: iotedge-edgebuilds-acr

#       - script: scripts/linux/buildBranch.sh -c $(Build.Configuration) --no-rocksdb-bin
#         name: build
#         displayName: Build ($(Build.Configuration)) dotnet artifacts

#       - template: templates/build-broker-watchdog.yaml

#       - script: scripts/linux/createArtifactInfo.sh --output-folder '$(Build.BinariesDirectory)/publish' --build-number $(Build.BuildNumber)
#         displayName: 'Create Artifact Info File'

#       - task: PublishBuildArtifacts@1
#         displayName: 'Publish Artifacts'
#         inputs:
#           PathtoPublish: '$(Build.BinariesDirectory)/publish'
#           ArtifactName: 'core-linux'

#       # Edge Agent
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Edge Agent
#           imageName: azureiotedge-agent
#           project: Microsoft.Azure.Devices.Edge.Agent.Service

#       # Edge Hub
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Edge Hub
#           imageName: azureiotedge-hub
#           project: edge-hub

#       # Simulated Temperature Sensor
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Temperature Sensor
#           imageName: azureiotedge-simulated-temperature-sensor
#           project: SimulatedTemperatureSensor

#       # Dotnet Diagnostics Module
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Diagnostics
#           imageName: azureiotedge-diagnostics
#           project: IotedgeDiagnosticsDotnet

#       # Temperature Filter
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Temperature Filter
#           imageName: azureiotedge-temperature-filter
#           project: TemperatureFilter

#       # Load Gen
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Load Gen
#           imageName: azureiotedge-load-gen
#           project: load-gen

#       # Test Analyzer
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Test Analyzer
#           imageName: azureiotedge-analyzer
#           project: TestAnalyzer

#       # Functions Sample - Not supported on linux arm64
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Functions Sample
#           imageName: azureiotedge-functions-filter
#           project: EdgeHubTriggerCSharp

#       # Direct Method Sender
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Direct Method Sender
#           imageName: azureiotedge-direct-method-sender
#           project: DirectMethodSender

#       # Direct Method Receiver
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Direct Method Receiver
#           imageName: azureiotedge-direct-method-receiver
#           project: DirectMethodReceiver

#       # Metrics Validator
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Metrics Validator
#           imageName: azureiotedge-metrics-validator
#           project: MetricsValidator

#       # Number Logger
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Number Logger
#           imageName: azureiotedge-number-logger
#           project: NumberLogger

#      # Module Restarter
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Module Restarter
#           imageName: azureiotedge-module-restarter
#           project: ModuleRestarter

#      # Twin Tester
#       - template: templates/image-linux.yaml
#         parameters:
#           name: TwinTester
#           imageName: azureiotedge-twin-tester
#           project: TwinTester

#      # Relayer
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Relayer
#           imageName: azureiotedge-relayer
#           project: Relayer

#     # Network Controller
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Network Controller
#           imageName: azureiotedge-network-controller
#           project: NetworkController

#      # TestResultCoordinator
#       - template: templates/image-linux.yaml
#         parameters:
#           name: TestResultCoordinator
#           imageName: azureiotedge-test-result-coordinator
#           project: TestResultCoordinator

#      # Metrics Collector
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Metrics Collector
#           imageName: azureiotedge-metrics-collector
#           project: MetricsCollector

#      # Deployment Tester
#       - template: templates/image-linux.yaml
#         parameters:
#           name: DeploymentTester
#           imageName: azureiotedge-deployment-tester
#           project: DeploymentTester

#      # EdgeHub Restart Tester
#       - template: templates/image-linux.yaml
#         parameters:
#           name: EdgeHubRestartTester
#           imageName: azureiotedge-edgehub-restart-tester
#           project: EdgeHubRestartTester

#      # Cloud To Device Message Tester
#       - template: templates/image-linux.yaml
#         parameters:
#           name: Cloud To Device Message Tester
#           imageName: azureiotedge-c2dmessage-tester
#           project: CloudToDeviceMessageTester

# ################################################################################
#   - job: linux_API_proxy_module
# ################################################################################
#     timeoutInMinutes: 180
#     displayName: linuxAPIProxy
#     pool:
#       name: $(pool.linux.name)
#       demands:
#         - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
#     steps:
#       - task: Docker@2
#         displayName: Docker login edgebuilds
#         inputs:
#           command: login
#           containerRegistry: iotedge-edgebuilds-acr
#       - bash: |
#             sudo apt-get update && sudo apt-get -y install qemu binfmt-support qemu-user-static && \
#             docker run --rm --privileged multiarch/qemu-user-static --reset -p yes && \
#             docker buildx rm  mbuilder || true  && \
#             docker buildx create --name mbuilder  || true  && \
#             docker buildx use mbuilder
#             docker -v
#       # Build API Proxy executable
#       - template: templates/build-api-proxy.yaml
#       # Build API Proxy Image
#       - template: templates/image-linux.yaml
#         parameters:
#           name: API Proxy
#           imageName: azureiotedge-api-proxy
#           project: api-proxy-module
#           buildx_flag: false
#       # Check API proxy
#       - task: ComponentGovernanceComponentDetection@0
#         inputs:
#           dockerImagesToScan: '$(registry.address)/microsoft/azureiotedge-api-proxy:$(Build.BuildNumber)-linux-amd64,$(registry.address)/microsoft/azureiotedge-api-proxy:$(Build.BuildNumber)-linux-arm32v7,$(registry.address)/microsoft/azureiotedge-api-proxy:$(Build.BuildNumber)-linux-arm64v8'

# ################################################################################
#   - job: RustTestModules
# ################################################################################
#     timeoutInMinutes: 180
#     displayName: Rust Test Modules
#     pool:
#       name: $(pool.linux.name)
#       demands:
#         - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
#     steps:
#       - template: templates/rust-test-module-build.yaml
#       - template: templates/rust-test-module-images.yaml
#         parameters:
#           module.path: 'test/modules/generic-mqtt-tester'
#           module.name: 'generic-mqtt-tester'

# ################################################################################
#   - job: manifest
# ################################################################################
#     displayName: Manifest
#     pool:
#       name: $(pool.linux.name)
#       demands:
#         - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
#     dependsOn:
#       - linux_dotnet_projects
#       - linux_API_proxy_module
#     variables:
#       tags: "['latest']"
#     steps:
#     - task: Docker@2
#       displayName: Docker login edgebuilds
#       inputs:
#         command: login
#         containerRegistry: iotedge-edgebuilds-acr
#     - script: scripts/linux/buildManifest.sh -r $(registry.address) -v $(Build.BuildNumber) -t $(System.DefaultWorkingDirectory)/edge-agent/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
#       displayName: 'Publish Edge Agent Manifest'
#     - script: scripts/linux/buildManifest.sh -r $(registry.address) -v $(Build.BuildNumber) -t $(System.DefaultWorkingDirectory)/edge-hub/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
#       displayName: 'Publish Edge Hub Manifest'
#     - script: scripts/linux/buildManifest.sh -r $(registry.address) -v $(Build.BuildNumber) -t $(System.DefaultWorkingDirectory)/edge-modules/SimulatedTemperatureSensor/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
#       displayName: 'Publish Temperature Sensor Manifest'
#     - script: scripts/linux/buildManifest.sh -r $(registry.address) -v $(Build.BuildNumber) -t $(System.DefaultWorkingDirectory)/edge-modules/iotedge-diagnostics-dotnet/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
#       displayName: 'Publish azureiotedge-diagnostics Manifest'
#     - script: scripts/linux/buildManifest.sh -r $(registry.address) -v $(Build.BuildNumber) -t $(System.DefaultWorkingDirectory)/edge-modules/api-proxy-module/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
#       displayName: 'Publish azureiotedge-api-proxy Manifest'
