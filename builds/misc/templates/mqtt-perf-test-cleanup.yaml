# Each test case template accepts a number of parameters and run three jobs:
# - Subscriber test job (demands: mqtt-perf-tests-sub) - starts mqtt-benchmark tool in subscriber mode
# - Publisher test job (demands: mqtt-perf-tests-pub) - starts mqtt-benchmark tool in publisher mode
# - Cleanup job - restarts docker container on a test host machine via SSH.

parameters:
- name: id # current test run id; required
  default: false
- name: brokerSshConnection # SSH Service Connection to connect to the test host machine; required.
  default: false
- name: dependencies # jobs that this cleanup job depens on; optional.
  default: []

jobs:

- job: "run_completed_${{ parameters['id'] }}"
  pool:
    name: $(pool.name)
    demands: mqtt-perf-tests-sub
  displayName: Cleanup
  dependsOn:
  - ${{ each dep in parameters.dependencies }}:
    - ${{ dep }}
  steps:
  - checkout: none

  - task: SSH@0
    displayName: Restart broker
    inputs:
      sshEndpoint: ${{ parameters['brokerSshConnection'] }}
      runOptions: commands
      commands: |
        docker restart mqtt-broker
    continueOnError: true 