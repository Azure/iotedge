parameters:
- name: build_only
  type: string
  default: ''
- name: targets
  type: object
  default:
  - arch: x86_64
  - arch: armv7l
  - arch: aarch64

jobs:
- ${{ each target in parameters.targets }}:
  - ${{ if or(not(parameters.build_only), endsWith(parameters.build_only, target.arch)) }}:
    - job: build_api_proxy_${{ target.arch }}
      displayName: Build API Proxy ${{ target.arch }}
      steps:
      - script: |
          scripts/linux/buildAPIProxy.sh \
            --project 'api-proxy-module' \
            --configuration 'release' \
            --target-arch ${{ target.arch }} \
            --bin-dir '$(Build.BinariesDirectory)'
        displayName: Build
      - task: PublishBuildArtifacts@1
        displayName: Publish artifacts
        inputs:
          pathtoPublish: '$(Build.BinariesDirectory)/publish'
          artifactName: api_proxy_${{ target.arch }}
          storeAsTar: true
