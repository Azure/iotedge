# This template will move the mqttd and watchdog artifacts into the EdgeHub dotnet publish folder
# EdgeHub's dotnet publish folder will serve as a minimal build context for the image
parameters:
  dotnet.artifacts.path: 'publish/Microsoft.Azure.Devices.Edge.Hub.Service'
  mqttd.artifacts.path: 'mqtt/target/'
  mqttd.config.path: 'mqtt/mqtt-broker/config/production.json'
  watchdog.artifacts.path: 'edge-hub/watchdog/target'
  all.artifacts.path: 'publish/edge-hub'

steps:
  - bash: |
      # Setup build context
      mkdir -p $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}
      mkdir -p $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}/mqttd
      mkdir -p $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}/watchdog

      # Copy watchdog artifacts
      cp  -r ${{ parameters['watchdog.artifacts.path'] }} $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}/watchdog

      # Copy mqtt artifacts
      cp  -r ${{ parameters['mqttd.artifacts.path'] }} $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}/mqttd
      cp ${{ parameters['mqttd.config.path'] }} $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}/mqttd

      # Copy edgehub artifacts
      mv  $(Build.BinariesDirectory)/${{ parameters['dotnet.artifacts.path'] }}/docker $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}
      mv $(Build.BinariesDirectory)/${{ parameters['dotnet.artifacts.path'] }} $(Build.BinariesDirectory)/${{ parameters['all.artifacts.path'] }}

    displayName: Copy edgehub, watchdog, and broker artifacts to single folder
