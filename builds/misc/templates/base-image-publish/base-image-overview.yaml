steps:
- pwsh: |
    # Note: With in the same job, you can access $(info), but it would interpret $(info) as string similar to `echo "$config"` which is undesirable for our case, we want an Object.
    # We worked around this by using the serialization & deserailzation
    $config = '$(serialize_config)' | ConvertFrom-Json

    # Fetch tags & version from each module Dockerfiles {../$(arch)/base/Dockerfile, ../$(arch)/Dockerfile}
    foreach ($eachConfig in $config)
    {
      # Steps: 
      #  1. Go to a respective Dockerfile as defined in base-image-config.yaml for an underlying base image
      #  2. Read underlying base image tag using "ARG base_tag="
      #  3. Go to a Dockerfile of the module to get tagging that refers to underly base image (2)
      #  4. Set a variable with the tag obtained in (3). This variable has the same name as config by item3 of base-image-config.yaml
      #  5. Output the read values. Format:  <BaseImageName>:<ReferringTag> ðŸ ˜ <UnderLyingBaseImageTag>
      $pathPrefix = "$(Build.SourcesDirectory)/$($eachConfig.Item1)/docker/$(os)/$(arch)"
      $unberlyingFilePath = $pathPrefix + '/base/Dockerfile' | Resolve-path
      $underlyingTag = $($(Get-Content $unberlyingFilePath | Select-String "ARG base_tag=") -split "=")[1]
      $imageFilePath = $pathPrefix + '/Dockerfile' | Resolve-path
      Set-Variable -Name "$($eachConfig.Item3)" -Value "$($($(Get-Content $imageFilePath | Select-String "ARG base_tag=") -split "=")[1])"
      Write-Output "$($eachConfig.Item2):$(Get-Variable -Name "$($eachConfig.Item3)" -ValueOnly) ðŸ ˜ $underlyingTag"

      # Extract version number from the *-linux* base image
      # Uses (ReturningVstsVar) + 'Version' to return the version string as VSTS variable
      #
      # Note:
      #    The output {$(edgeAgentTagVersion), $(edgeHubTagVersion), $(moduleTagVersion), $(fullModuleTagVersion)} are used in base-image-build-and-publish.yaml
      Write-Output "##vso[task.setvariable variable=$($eachConfig.Item3)Version]$($(Get-Variable -Name "$($eachConfig.Item3)" -ValueOnly).split("-")[0])"
    }
  displayName: Overview
  name: overview