name: $(version)
trigger: none
pr: none

variables:
  NugetSecurityAnalysisWarningLevel: warn
  
jobs:
################################################################################
  - job: MetricsCollector
################################################################################
    displayName: MetricsCollector
    timeoutInMinutes: 120
    pool:
      vmImage: 'ubuntu-18.04'
    steps:
      - bash: |
            # Need to login to EdgeBuilds Container Registry for base images.
            docker login '$(registry.address)' --username '$(registry.user)' --password '$(registry.password)'
        displayName: 'Docker Login'
      - script: scripts/linux/buildBranch.sh -c $(Build.Configuration) --no-rocksdb-bin
        name: build
        displayName: Build ($(Build.Configuration))
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifacts'
        inputs:
          PathtoPublish: '$(Build.BinariesDirectory)/publish'
          ArtifactName: 'core-linux'
      - template: templates/image-linux.yaml
        parameters:
          name: Metrics Collector (customer-facing)
          imageName: azureiotedge-metrics-collector
          project: Microsoft.Azure.Devices.Edge.Azure.Monitor

################################################################################
  - job: manifest
################################################################################
    displayName: Publish Manifest Images
    pool:
      vmImage: 'ubuntu-18.04'
    dependsOn:
      - MetricsCollector
    steps:
    - script: scripts/linux/buildManifest.sh -r $(registry.address) -u $(registry.user) -p $(registry.password) -v $(version) -t $(System.DefaultWorkingDirectory)/edge-modules/azure-monitor/docker/manifest.yaml.template -n microsoft --tags "$(tags)"
      displayName: 'Publish azureiotedge-api-proxy Manifest'