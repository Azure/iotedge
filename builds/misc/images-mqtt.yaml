trigger:
  batch: true
  branches:
    include:
      - master
pr: none

jobs:
################################################################################
  - job: linux_amd64
################################################################################
    displayName: Linux AMD64
    pool:
      vmImage: 'ubuntu-latest'

    variables:
      imageName: $(registry.address)/azureiotedge/mqttd-linux-amd64

    steps:
      - task: Docker@2
        displayName: Docker Login
        inputs:
          command: login
          containerRegistry: iotedge-edgebuilds-acr

      - task: Docker@2
        displayName: Build amd64 image
        inputs:
          repository: $(imageName)
          command: build
          Dockerfile: mqtt/docker/linux/amd64/Dockerfile
          buildContext: mqtt/.

      - task: Docker@2
          displayName: Docker Push
          inputs:
            containerRegistry: iotedge-edgebuilds-acr
            repository: $(imageName)
            command: push

################################################################################
  - job: linux_arm32
################################################################################
    displayName: Linux ARM32
    pool:
      vmImage: 'ubuntu-latest'

    variables:
      imageName: $(registry.address)/azureiotedge/mqttd-linux-arm32v7

    steps:
      - task: Docker@2
        displayName: Docker Login
        inputs:
          command: login
          containerRegistry: iotedge-edgebuilds-acr

      - task: Docker@2
        displayName: Build arm32v7 image
        inputs:
          repository: $(imageName)
          command: build
          Dockerfile: mqtt/docker/linux/arm32v7/Dockerfile
          buildContext: mqtt/.

      - task: Docker@2
        displayName: Docker Push
        inputs:
          containerRegistry: iotedge-edgebuilds-acr
          repository: $(imageName)
          command: push