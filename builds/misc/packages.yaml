trigger:
  batch: true
  branches:
    include:
      - master
pr: none
variables:
  REVISION: '1'
jobs:

################################################################################
  - job: windows_amd64
################################################################################
    displayName: Windows amd64
    pool:
      vmImage: 'vs2017-win2016'
    steps:
      - powershell: |
          $base_version = Get-Content -Path "$(Build.SourcesDirectory)\edgelet\version.txt"
          $version = ("{0}{1}" -f $base_version, $(Build.BuildNumber))
          Write-Host ("##vso[task.setvariable variable=VERSION;]$version")
          Write-Host ("##vso[task.setvariable variable=NO_VALGRIND;]true")
          Write-Host "Setting version: '$version'"
          invoke-webrequest "https://go.microsoft.com/fwlink/?linkid=2026036" -OutFile $env:SystemRoot\adksetup.exe
          adksetup.exe /quiet
          sleep 60
          write-host "take 1"
          pushd c:\; pwd; cmd /c dir /s makecat.exe
          pushd c:\; pwd; cmd /c dir /s sign*.cmd
          dir "C:\Program Files (x86)\Windows Kits\10\bin\x64\makecat.exe"
          dir "hklm:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{3dec9467-d9ad-42df-8e84-888057bac8f1}"
          sleep 60
          write-host "take 2"
          pushd c:\; pwd; cmd /c dir /s makecat.exe
          pushd c:\; pwd; cmd /c dir /s sign*.cmd
          dir "C:\Program Files (x86)\Windows Kits\10\bin\x64\makecat.exe"
          dir "hklm:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{3dec9467-d9ad-42df-8e84-888057bac8f1}"
          sleep 60
          write-host "take 3"
          pushd c:\; pwd; cmd /c dir /s makecat.exe
          pushd c:\; pwd; cmd /c dir /s sign*.cmd
          dir "C:\Program Files (x86)\Windows Kits\10\bin\x64\makecat.exe"
          dir "hklm:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{3dec9467-d9ad-42df-8e84-888057bac8f1}"
          sleep 60
          write-host "take 4"
          pushd c:\; pwd; cmd /c dir /s makecat.exe
          pushd c:\; pwd; cmd /c dir /s sign*.cmd
          dir "C:\Program Files (x86)\Windows Kits\10\bin\x64\makecat.exe"
          dir "hklm:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{3dec9467-d9ad-42df-8e84-888057bac8f1}"
        displayName: Set Version
      - powershell: edgelet/build/windows/install.ps1
        displayName: Install Rust
      - powershell: edgelet/build/windows/build.ps1 -Release
        displayName: Build
      - task: CMake@1
        displayName: 'Setup libiothsm'
        inputs:
          workingDirectory: 'edgelet/hsm-sys/azure-iot-hsm-c/build'
          cmakeArgs: '-G "Visual Studio 15 2017 Win64" -DBUILD_SHARED=ON -Duse_emulator=OFF ..'
      - task: CMake@1
        displayName: 'Build libiothsm'
        inputs:
          workingDirectory: 'edgelet/hsm-sys/azure-iot-hsm-c/build'
          cmakeArgs: '--build . --config Release'
      - powershell: edgelet/build/windows/package.ps1
        displayName: Package iotedged, iotedge, libiothsm and docker/dockerd
      - task: CopyFiles@2
        displayName: 'Copy iotedged to Artifact Staging'
        inputs:
          SourceFolder: edgelet/target/release
          Contents: |
            *.exe
            *.pdb
            *.dll
          TargetFolder: '$(build.artifactstagingdirectory)'
      - task: CopyFiles@2
        displayName: 'Copy libiothsm to Artifact Staging'
        inputs:
          SourceFolder: 'edgelet/hsm-sys/azure-iot-hsm-c/build/Release'
          Contents: |
            *.dll
            *.pdb
          TargetFolder: '$(build.artifactstagingdirectory)'
      - task: CopyFiles@2
        displayName: 'Copy legal docs to Artifact Staging'
        inputs:
          SourceFolder: edgelet/contrib/docs
          TargetFolder: '$(build.artifactstagingdirectory)/LICENSE'
      - task: CopyFiles@2
        displayName: 'Copy config to Artifact Staging'
        inputs:
          SourceFolder: edgelet/contrib/config/windows
          TargetFolder: '$(build.artifactstagingdirectory)'
      - task: CopyFiles@2
        displayName: 'Copy package to Artifact Staging'
        inputs:
          SourceFolder: .
          Contents: |
            *.cab
          TargetFolder: '$(build.artifactstagingdirectory)'
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: iotedged-windows'
        inputs:
          PathtoPublish: '$(build.artifactstagingdirectory)'
          ArtifactName: 'iotedged-windows'
