name: $(version)
variables:
  NugetSecurityAnalysisWarningLevel: warn
  from.registry.address: 'edgerelease.azurecr.io'
  from.registry.namespace: 'microsoft'
  to.registry.address: 'edgerelease.azurecr.io'
  to.registry.namespace: 'public'

jobs:
################################################################################
  - job: publish_linux_images
################################################################################
    timeoutInMinutes: 180
    displayName: Publish Linux Images
    pool:
      vmImage: ubuntu-18.04
    steps:

      # Both docker logins needed for if we need to test this job. In this case images should go to edgebuilds.
      - task: Docker@2
        displayName: Docker login edgebuilds
        inputs:
          command: login
          containerRegistry: iotedge-edgebuilds-acr

      - task: Docker@2
        displayName: Docker login edgerelease
        inputs:
          command: login
          containerRegistry: iotedge-release-acr

      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/repo/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'
