name: $(version)
variables:
  NugetSecurityAnalysisWarningLevel: warn
  from.registry.address: 'edgebuilds.azurecr.io'
  from.registry.namespace: 'microsoft'
  to.registry.address: 'edgebuilds.azurecr.io'
  to.registry.namespace: 'public'
  pool.linux.name: 'Azure-IoT-Edge-1ES-Hosted-Linux'
  tags: '7.8.21'
  tempSensor.tags: '7.8.21'

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Images Release YAML'
    branch: 'release/1.2'

jobs:
################################################################################
  - job: publish_linux_images
################################################################################
    timeoutInMinutes: 180
    displayName: Publish Linux Images
    pool:
      name: $(pool.linux.name)
      demands:
        - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
    steps:
      # Both docker logins needed for if we need to test this job. In this case images should go to edgebuilds.
      - task: Docker@2
        displayName: Docker login edgebuilds
        inputs:
          command: login
          containerRegistry: iotedge-edgebuilds-acr

      - task: Docker@2
        displayName: Docker login edgerelease
        inputs:
          command: login
          containerRegistry: iotedge-release-acr

      # BEARWASHERE -- Use the $(Release.Artifacts.images.BuildNumber) from Resource option 
      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Edge Agent - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-agent:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Edge Hub - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-hub:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish Temp Sensor - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-simulated-temperature-sensor:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux amd64'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-amd64 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-amd64'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux arm32v7'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm32v7'

      - task: ShellScript@2
        displayName: 'Publish diagnostics - Linux arm64v8'
        inputs:
          scriptPath: '$(System.DefaultWorkingDirectory)/scripts/linux/moveImage.sh'
          args: '--from $(from.registry.address)/$(from.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8 --to $(to.registry.address)/$(to.registry.namespace)/azureiotedge-diagnostics:$(Release.Artifacts.images.BuildNumber)-linux-arm64v8'

################################################################################
  - job: publish_manifest_images
################################################################################
    timeoutInMinutes: 180
    displayName: Publish Manifest Images
    dependsOn: publish_linux_images
    pool:
      name: $(pool.linux.name)
      demands:
        - ImageOverride -equals agent-aziotedge-ubuntu-18.04-docker
    steps:
      # Both docker logins needed for if we need to test this job. In this case images should go to edgebuilds.
      - task: Docker@2
        displayName: Docker login edgebuilds
        inputs:
          command: login
          containerRegistry: iotedge-edgebuilds-acr

      - task: Docker@2
        displayName: Docker login edgerelease
        inputs:
          command: login
          containerRegistry: iotedge-release-acr

      - task: Bash@3
        displayName: 'Publish Edge Agent Manifest'
        inputs:
          targetType: filePath
          filePath: './$(System.DefaultWorkingDirectory)/scripts/linux/buildManifest.sh'
          arguments: '-r "$(to.registry.address)" -v "$(Release.Artifacts.images.BuildNumber)" -t $(System.DefaultWorkingDirectory)/edge-agent/docker/manifest.yaml.template -n "$(to.registry.namespace)" --tags "$(tags)"'
        env:
          BUILD_REPOSITORY_LOCALPATH: $(System.DefaultWorkingDirectory)

      - task: Bash@3
        displayName: 'Publish Edge Hub Manifest'
        inputs:
          targetType: filePath
          filePath: './$(System.DefaultWorkingDirectory)/scripts/linux/buildManifest.sh'
          arguments: '-r "$(to.registry.address)" -v "$(Release.Artifacts.images.BuildNumber)" -t $(System.DefaultWorkingDirectory)/edge-hub/docker/manifest.yaml.template -n "$(to.registry.namespace)" --tags "$(tags)"'
        env:
          BUILD_REPOSITORY_LOCALPATH: $(System.DefaultWorkingDirectory)

      - task: Bash@3
        displayName: 'Publish Temperature Sensor Manifest'
        inputs:
          targetType: filePath
          filePath: './$(System.DefaultWorkingDirectory)/scripts/linux/buildManifest.sh'
          arguments: '-r "$(to.registry.address)" -v "$(Release.Artifacts.images.BuildNumber)" -t $(System.DefaultWorkingDirectory)/edge-modules/SimulatedTemperatureSensor/docker/manifest.yaml.template -n "$(to.registry.namespace)" --tags "$(tempSensor.tags)"'
        env:
          BUILD_REPOSITORY_LOCALPATH: $(System.DefaultWorkingDirectory)

      - task: Bash@3
        displayName: 'Publish diagnostics Manifest'
        inputs:
          targetType: filePath
          filePath: './$(System.DefaultWorkingDirectory)/scripts/linux/buildManifest.sh'
          arguments: '-r "$(to.registry.address)" -v "$(Release.Artifacts.images.BuildNumber)" -t $(System.DefaultWorkingDirectory)/edge-modules/iotedge-diagnostics-dotnet/docker/manifest.yaml.template -n "$(to.registry.namespace)" --tags "$(tags)"'
        env:
          BUILD_REPOSITORY_LOCALPATH: $(System.DefaultWorkingDirectory)