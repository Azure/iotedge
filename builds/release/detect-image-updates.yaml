trigger: none
pr: none

schedules:
# Twice daily (7AM/PM PST)
- cron: "0 3,15 * * *"
  displayName: Twice daily check (8AM/PM PDT)
  branches:
    include:
    - main
    - release/*
  always: true

resources:
  repositories:
  - repository: product
    type: github
    endpoint: Azure/azure-iotedge
    name: Azure/azure-iotedge

variables:
  NugetSecurityAnalysisWarningLevel: warn
  DisableDockerDetector: true

pool:
  name: $(pool.linux.name)
  demands:
  - ImageOverride -equals agent-aziotedge-ubuntu-20.04-docker

steps:
- checkout: product
  fetchDepth: 0

- script: |
    #!/bin/bash
    set -euo pipefail

    branch="${BUILD_SOURCEBRANCH#refs/heads/}"

    # transform product-versions.json into a list of images for each product in this branch
    images_json=$(cat product-versions.json | jq --arg registry "$REGISTRY" --arg branch "$branch" '
      def is_image: has("type") and .type == "dockerImage";
      def platforms: .componentTypes[] | select(.name == "dockerImage") | .platforms[] | { os, arch: .arch[] | . };
      [
        .channels[] | .products[] | select(
          .components | any(is_image and .repo == "Azure/iotedge" and .branch == $branch)
        ) | {
          product: .id, version, images: [
            platforms as $platforms | .components[] | select(is_image) | . as { $name, $version } | $platforms
              | @text "\($registry)/\($name):\($version)-\(.os)-\(.arch)"
          ] | sort
        }
      ] | unique
    ')

    # use build metadata present in each published image to determine if it is out of date
    remove=( )
    images=( $(echo "$images_json" | jq -r '[ .[].images ] | flatten | join("\n")') )
    for image in ${images[@]}
    do
      echo "image: $image"

      read base_image current_digest <<< $(\
        docker buildx imagetools inspect $image --format '{{json .Provenance}}' |
        jq -r '[ .SLSA // halt | .materials[] | select(.uri | startswith("pkg:docker/docker/dockerfile") | not) ] |
        if length == 1 then first else (
          "Error: inspect command found more than one base image in provenance materials\n\(.)" | halt_error
        ) end | "\(.uri) \(.digest.sha256)"'
      )

      if [ -n "$base_image" ]
      then
        # base image is in the format 'pkg:docker/image@tag?name=value'
        # first strip off the front of the uri and the query string
        read image query <<< "${base_image/#pkg:docker\//}"
        # then replace '@' with ':'
        base_image="${image/@/:}"
      else
        echo "'$image' does not contain provenance metadata. Skipping..."
        remove+=( "$image" )
        continue
      fi

      latest_digest="$(docker buildx imagetools inspect $base_image --format '{{json .Manifest}}' | jq -r '.digest')"

      echo -e "  base:\t\t$base_image\n  current:\t$current_digest\n  latest:\t$latest_digest"

      if [ -n "$current_digest" ] && [ "$current_digest" != "$latest_digest" ]
      then
        echo "  ## NEEDS UPDATE ##"
      else
        remove+=( "$image" )
      fi
    done

    # filter up-to-date images out of the list
    remove_json=$(printf '%s\n' "${remove[@]}" | jq -R '.' | jq -s '.')
    images_json=$(echo "$images_json" | jq --argjson remove "$remove_json" '
      [ .[] | { product, version, images: (.images - $remove) } | select(.images | length != 0) ]
    ')

    if [ $(echo "$images_json" | jq '. | length != 0') == 'true' ]
    then
      echo 'Found images that need to be updated:'
      echo "$images_json" | jq '.'
    else
      echo 'All images are up to date. Nothing to do...'
    fi

    echo "$images_json" > $(Build.ArtifactStagingDirectory)/updates.json
  displayName: Detect base image updates
  env:
    REGISTRY: mcr.microsoft.com

- task: PublishBuildArtifacts@1
  displayName: Save list of images to update
  inputs:
    pathtoPublish: '$(Build.ArtifactStagingDirectory)/updates.json'
    artifactName: image-updates
