{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"key_vault_access_objectid": {
			"type": "string"
		},
		"key_vault_name": {
			"type": "string"
		},
		"key_vault_secret_name": {
			"type": "string"
		},
		"vms_ssh_key_encoded": {
			"type": "securestring"
		},
		"vms_ssh_public_key": {
			"type": "string"
		},
		"vms_username": {
			"type": "string"
		},
		"vms_vnet_address_prefix": {
			"type": "string"
		},
		"vms_vnet_name": {
			"type": "string"
		},
		"vms_vnet_subnet_name": {
			"type": "string"
		},
		"vsts_agent_vm_name": {
			"type": "string"
		},
		"vsts_agent_vm_public_ip_name": {
			"type": "string"
		},
		"vsts_runner1_vm_name": {
			"type": "string"
		},
		"vsts_runner2_vm_name": {
			"type": "string"
		},
		"windows_vm_password": {
			"type": "securestring"
		},
		"vsts_agent_vm_network_interface_name": {
			"defaultValue": "e2eproxyvstsagent",
			"type": "string"
		},
		"vsts_agent_vm_nsg_name": {
			"defaultValue": "e2eproxyvstsagent",
			"type": "string"
		},
		"vsts_agent_vm_public_nsg_name": {
			"defaultValue": "e2eproxyvstsagentpublic",
			"type": "string"
		},
		"vsts_agent_vm_size": {
			"defaultValue": "Standard_DS1_v2",
			"type": "string"
		},
		"vsts_runner1_vm_network_interface_name": {
			"defaultValue": "e2eproxyvstsrunner1",
			"type": "string"
		},
		"vsts_runner1_vm_size": {
			"defaultValue": "Standard_D2s_v3",
			"type": "string"
		},
		"vsts_runner2_vm_network_interface_name": {
			"defaultValue": "e2eproxyvstsrunner2",
			"type": "string"
		},
		"vsts_runner2_vm_size": {
			"defaultValue": "Standard_D2s_v3",
			"type": "string"
		},
		"vsts_runner_vms_nsg_name": {
			"defaultValue": "e2eproxyvstsrunners",
			"type": "string"
		}
	},
	"variables": {
		"agent_prep_script_uri": "https://raw.githubusercontent.com/Azure/iotedge/master/builds/e2e/agent.sh",
		"linux_runner_prep_script_uri": "https://raw.githubusercontent.com/Azure/iotedge/master/builds/e2e/runner.sh",
		"windows_runner_prep_script_uri": "https://raw.githubusercontent.com/Azure/iotedge/master/builds/e2e/Runner.ps1",
		"update_agent_known_hosts_script_uri": "https://raw.githubusercontent.com/Azure/iotedge/master/builds/e2e/known_hosts.sh"
	},
	"resources": [{
		"type": "Microsoft.Network/virtualNetworks",
		"name": "[parameters('vms_vnet_name')]",
		"apiVersion": "2018-10-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"addressSpace": {
				"addressPrefixes": [
					"[parameters('vms_vnet_address_prefix')]"
				]
			},
			"subnets": [
				{
					"name": "[parameters('vms_vnet_subnet_name')]",
					"properties": {
						"addressPrefix": "[parameters('vms_vnet_address_prefix')]"
					}
				}
			]
		},
		"dependsOn": []
	}, {
		"type": "Microsoft.KeyVault/vaults",
		"name": "[parameters('key_vault_name')]",
		"apiVersion": "2018-02-14",
		"location": "[resourceGroup().location]",
		"properties": {
			"sku": {
				"family": "A",
				"name": "standard"
			},
			"tenantId": "[subscription().tenantId]",
			"accessPolicies": [
				{
					"tenantId": "[subscription().tenantId]",
					"objectId": "[parameters('key_vault_access_objectid')]",
					"permissions": {
						"keys": [ "all" ],
						"secrets": [ "all" ],
						"certificates": [ "all" ]
					}
				}
			],
			"enabledForDeployment": false,
			"enabledForDiskEncryption": false,
			"enabledForTemplateDeployment": true
		},
		"dependsOn": []
	}, {
		"type": "Microsoft.KeyVault/vaults/secrets",
		"name": "[concat(parameters('key_vault_name'), '/', parameters('key_vault_secret_name'))]",
		"apiVersion": "2018-02-14",
		"properties": {
			"value": "[parameters('windows_vm_password')]"
		},
		"dependsOn": [
			"[concat('Microsoft.KeyVault/vaults', '/', parameters('key_vault_name'))]"
		]
	},{
		"type": "Microsoft.Network/networkSecurityGroups",
		"name": "[parameters('vsts_agent_vm_nsg_name')]",
		"apiVersion": "2018-02-01",
		"location": "[resourceGroup().location]",
		"scale": null,
		"properties": {
			"provisioningState": "Succeeded",
			"securityRules": [{
				"name": "ssh",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "Tcp",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "*",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "22",
					"direction": "Inbound",
					"access": "Allow",
					"priority": 200
				}
			}, {
				"name": "AllowVnetInBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "VirtualNetwork",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "VirtualNetwork",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Inbound",
					"access": "Allow",
					"priority": 300
				}
			}, {
				"name": "DenyAllInBound",
				"properties": {
					"provisioningState": "Succeeded",
					"description": "Deny all inbound traffic",
					"protocol": "*",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "*",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Inbound",
					"access": "Deny",
					"priority": 400
				}
			}, {
				"name": "AllowVnetOutBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "VirtualNetwork",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "VirtualNetwork",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Outbound",
					"access": "Allow",
					"priority": 500
				}
			}, {
				"name": "AllowInternetOutBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "Internet",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Outbound",
					"access": "Allow",
					"priority": 600
				}
			}, {
				"name": "DenyAllOutBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "*",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Outbound",
					"access": "Deny",
					"priority": 700
				}
			}],
			"defaultSecurityRules": []
		},
		"dependsOn": []
	}, {
		"type": "Microsoft.Network/networkSecurityGroups",
		"name": "[parameters('vsts_runner_vms_nsg_name')]",
		"apiVersion": "2018-02-01",
		"location": "[resourceGroup().location]",
		"scale": null,
		"properties": {
			"provisioningState": "Succeeded",
			"securityRules": [{
				"name": "AllowVnetInBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "VirtualNetwork",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "VirtualNetwork",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Inbound",
					"access": "Allow",
					"priority": 200
				}
			}, {
				"name": "DenyAllInBound",
				"properties": {
					"provisioningState": "Succeeded",
					"description": "Deny all inbound traffic",
					"protocol": "*",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "*",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Inbound",
					"access": "Deny",
					"priority": 300
				}
			}, {
				"name": "AllowVnetOutBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "VirtualNetwork",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "VirtualNetwork",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Outbound",
					"access": "Allow",
					"priority": 400
				}
			}, {
				"name": "DenyAllOutBound",
				"properties": {
					"provisioningState": "Succeeded",
					"protocol": "*",
					"sourceAddressPrefix": "*",
					"sourceAddressPrefixes": [],
					"sourcePortRange": "*",
					"destinationAddressPrefix": "*",
					"destinationAddressPrefixes": [],
					"destinationPortRange": "*",
					"direction": "Outbound",
					"access": "Deny",
					"priority": 500
				}
			}],
			"defaultSecurityRules": []
		},
		"dependsOn": []
	}, {
		"type": "Microsoft.Network/publicIPAddresses",
		"name": "[parameters('vsts_agent_vm_public_ip_name')]",
		"apiVersion": "2018-02-01",
		"sku": {
			"name": "Basic",
			"tier": "Regional"
		},
		"location": "[resourceGroup().location]",
		"properties": {
			"publicIPAddressVersion": "IPv4",
			"publicIPAllocationMethod": "Dynamic"
		},
		"dependsOn": []
	}, {
		"type": "Microsoft.Network/networkInterfaces",
		"name": "[parameters('vsts_agent_vm_network_interface_name')]",
		"apiVersion": "2018-02-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"ipConfigurations": [{
				"name": "ipconfig1",
				"properties": {
					"subnet": {
						"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', parameters('vms_vnet_name'), parameters('vms_vnet_subnet_name'))]"
					},
					"privateIPAllocationMethod": "Dynamic",
					"publicIPAddress": {
						"id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('vsts_agent_vm_public_ip_name'))]"
					}
				}
			}],
			"networkSecurityGroup": {
				"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_agent_vm_nsg_name'))]"
			},
			"primary": false
		},
		"dependsOn": [
			"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_agent_vm_nsg_name'))]",
			"[resourceId('Microsoft.Network/publicIPAddresses', parameters('vsts_agent_vm_public_ip_name'))]"
		]
	}, {
		"type": "Microsoft.Network/networkInterfaces",
		"name": "[parameters('vsts_runner1_vm_network_interface_name')]",
		"apiVersion": "2018-02-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"ipConfigurations": [{
				"name": "ipconfig1",
				"properties": {
					"subnet": {
						"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', parameters('vms_vnet_name'), parameters('vms_vnet_subnet_name'))]"
					},
					"privateIPAllocationMethod": "Dynamic"
				}
			}],
			"networkSecurityGroup": {
				"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_runner_vms_nsg_name'))]"
			},
			"primary": false
		},
		"dependsOn": [
			"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_runner_vms_nsg_name'))]"
		]
	}, {
		"type": "Microsoft.Network/networkInterfaces",
		"name": "[parameters('vsts_runner2_vm_network_interface_name')]",
		"apiVersion": "2018-02-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"ipConfigurations": [{
				"name": "ipconfig1",
				"properties": {
					"subnet": {
						"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks/subnets', parameters('vms_vnet_name'), parameters('vms_vnet_subnet_name'))]"
					},
					"privateIPAllocationMethod": "Dynamic"
				}
			}],
			"networkSecurityGroup": {
				"id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_runner_vms_nsg_name'))]"
			},
			"primary": true
		},
		"dependsOn": [
			"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('vsts_runner_vms_nsg_name'))]"
		]
	}, {
		"type": "Microsoft.Compute/virtualMachines",
		"name": "[parameters('vsts_agent_vm_name')]",
		"apiVersion": "2017-12-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"osProfile": {
				"computerName": "[parameters('vsts_agent_vm_name')]",
				"adminUsername": "[parameters('vms_username')]",
				"linuxConfiguration": {
					"disablePasswordAuthentication": true,
					"ssh": {
						"publicKeys": [{
							"path": "[concat('/home/', parameters('vms_username'), '/.ssh/authorized_keys')]",
							"keyData": "[parameters('vms_ssh_public_key')]"
						}]
					}
				}
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vsts_agent_vm_size')]"
			},
			"storageProfile": {
				"imageReference": {
					"publisher": "Canonical",
					"offer": "UbuntuServer",
					"sku": "18.04-LTS",
					"version": "latest"
				},
				"osDisk": {
					"createOption": "FromImage",
					"managedDisk": {
						"storageAccountType": "Standard_LRS"
					}
				},
				"dataDisks": []
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_agent_vm_network_interface_name'))]",
					"properties": {
						"primary": true
					}
				}]
			}
		},
		"dependsOn": [
			"[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_agent_vm_network_interface_name'))]"
		]
	}, {
		"type": "Microsoft.Compute/virtualMachines",
		"name": "[parameters('vsts_runner1_vm_name')]",
		"apiVersion": "2017-12-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"osProfile": {
				"computerName": "[parameters('vsts_runner1_vm_name')]",
				"adminUsername": "[parameters('vms_username')]",
				"linuxConfiguration": {
					"disablePasswordAuthentication": true,
					"ssh": {
						"publicKeys": [{
							"path": "[concat('/home/', parameters('vms_username'), '/.ssh/authorized_keys')]",
							"keyData": "[parameters('vms_ssh_public_key')]"
						}]
					}
				}
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vsts_runner1_vm_size')]"
			},
			"storageProfile": {
				"imageReference": {
					"publisher": "Canonical",
					"offer": "UbuntuServer",
					"sku": "18.04-LTS",
					"version": "latest"
				},
				"osDisk": {
					"createOption": "FromImage",
					"managedDisk": {
						"storageAccountType": "Standard_LRS"
					}
				},
				"dataDisks": []
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_runner1_vm_network_interface_name'))]",
					"properties": {
						"primary": false
					}
				}]
			}
		},
		"dependsOn": [
			"[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_runner1_vm_network_interface_name'))]"
		]
	}, {
		"type": "Microsoft.Compute/virtualMachines",
		"name": "[parameters('vsts_runner2_vm_name')]",
		"apiVersion": "2017-12-01",
		"location": "[resourceGroup().location]",
		"properties": {
			"osProfile": {
				"computerName": "[parameters('vsts_runner2_vm_name')]",
				"adminUsername": "[parameters('vms_username')]",
				"adminPassword": "[parameters('windows_vm_password')]",
				"windowsConfiguration": {
					"enableAutomaticUpdates": true
				}
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vsts_runner2_vm_size')]"
			},
			"storageProfile": {
				"imageReference": {
					"publisher": "MicrosoftWindowsServer",
					"offer": "WindowsServer",
					"sku": "2019-Datacenter-Core",
					"version": "latest"
				},
				"osDisk": {
					"osType": "Windows",
					"createOption": "FromImage",
					"managedDisk": {
						"storageAccountType": "Standard_LRS"
					}
				},
				"dataDisks": []
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_runner2_vm_network_interface_name'))]",
					"properties": {
						"primary": true
					}
				}]
			}
		},
		"dependsOn": [
			"[resourceId('Microsoft.Network/networkInterfaces', parameters('vsts_runner2_vm_network_interface_name'))]"
		]
	}, {
		"type": "Microsoft.Compute/virtualMachines/extensions",
		"name": "[concat(parameters('vsts_agent_vm_name'), '/', 'init-proxy')]",
		"apiVersion": "2015-06-15",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_agent_vm_name'))]"
		],
		"properties": {
			"publisher": "Microsoft.Azure.Extensions",
			"type": "CustomScript",
			"typeHandlerVersion": "2.0",
			"autoUpgradeMinorVersion": true,
			"settings": {},
			"protectedSettings": {
				"commandToExecute": "[concat('/bin/bash -c \"set -euo pipefail && curl ', variables('agent_prep_script_uri'), ' | sudo bash -s -- ', parameters('vms_username'), ' ', parameters('vms_ssh_key_encoded'), ' ', reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vms_vnet_name'), parameters('vms_vnet_subnet_name')), '2018-08-01').addressPrefix, '\"')]"
			}
		}
	}, {
		"type": "Microsoft.Compute/virtualMachines/extensions",
		"name": "[concat(parameters('vsts_runner1_vm_name'), '/', 'init-runner')]",
		"apiVersion": "2015-06-15",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_runner1_vm_name'))]",
			"[resourceId('Microsoft.Compute/virtualMachines/extensions/', parameters('vsts_agent_vm_name'), 'init-proxy')]"
		],
		"properties": {
			"publisher": "Microsoft.Azure.Extensions",
			"type": "CustomScript",
			"typeHandlerVersion": "2.0",
			"autoUpgradeMinorVersion": true,
			"settings": {},
			"protectedSettings": {
				"commandToExecute": "[concat('/bin/bash -c \"set -euo pipefail && curl -x ', parameters('vsts_agent_vm_name'), ':3128 ', variables('linux_runner_prep_script_uri'), ' | sudo bash -s -- ', parameters('vsts_agent_vm_name'), ' ', parameters('vms_username'), '\"')]"
			}
		}
	}, {
		"type": "Microsoft.Compute/virtualMachines/extensions",
		"name": "[concat(parameters('vsts_runner2_vm_name'), '/', 'init-runner')]",
		"apiVersion": "2018-06-01",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_runner2_vm_name'))]",
			"[resourceId('Microsoft.Compute/virtualMachines/extensions/', parameters('vsts_agent_vm_name'), 'init-proxy')]"
		],
		"properties": {
			"publisher": "Microsoft.Compute",
			"type": "CustomScriptExtension",
			"typeHandlerVersion": "1.9",
			"autoUpgradeMinorVersion": true,
			"settings": {},
			"protectedSettings": {
				"commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -Command \"& { . { Invoke-WebRequest -UseBasicParsing -Proxy http://', parameters('vsts_agent_vm_name'), ':3128 -Uri ', variables('windows_runner_prep_script_uri'), ' } | Invoke-Expression; Initialize-WindowsVM -ProxyHostname ', parameters('vsts_agent_vm_name'), ' -SshPublicKeyBase64 ', base64(parameters('vms_ssh_public_key')), ' }\"')]"
			}
		}
	}, {
		"type": "Microsoft.Compute/virtualMachines/extensions",
		"name": "[concat(parameters('vsts_runner1_vm_name'), '/', 'update-agent-known-hosts')]",
		"apiVersion": "2018-06-01",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_runner1_vm_name'), 'init-runner')]",
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_agent_vm_name'))]"
		],
		"properties": {
			"publisher": "Microsoft.Compute",
			"type": "CustomScriptExtension",
			"typeHandlerVersion": "1.9",
			"autoUpgradeMinorVersion": true,
			"settings": {},
			"protectedSettings": {
				"commandToExecute": "[concat('/bin/bash -c \"set -euo pipefail && curl ', variables('update_agent_known_hosts_script_uri'), ' | sudo bash -s -- ', parameters('vms_username'), ' ', parameters('vsts_runner1_vm_name'), ' ', split(string(reference(resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vsts_runner1_vm_name'), 'init-runner')).instanceView), '#DATA#')[1] '\"')]"
			}
		}
	}, {
		"type": "Microsoft.Compute/virtualMachines/extensions",
		"name": "[concat(parameters('vsts_runner2_vm_name'), '/', 'update-agent-known-hosts')]",
		"apiVersion": "2018-06-01",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_runner2_vm_name'), 'init-runner')]",
			"[resourceId('Microsoft.Compute/virtualMachines/', parameters('vsts_agent_vm_name'))]"
		],
		"properties": {
			"publisher": "Microsoft.Compute",
			"type": "CustomScriptExtension",
			"typeHandlerVersion": "1.9",
			"autoUpgradeMinorVersion": true,
			"settings": {},
			"protectedSettings": {
				"commandToExecute": "[concat('/bin/bash -c \"set -euo pipefail && curl ', variables('update_agent_known_hosts_script_uri'), ' | sudo bash -s -- ', parameters('vms_username'), ' ', parameters('vsts_runner2_vm_name'), ' ', split(string(reference(resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vsts_runner2_vm_name'), 'init-runner')).instanceView), '#DATA#')[1] '\"')]"
			}
		}
	}]
}
