trigger: none
pr: none

variables:
  NugetSecurityAnalysisWarningLevel: warn

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: master
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: master

stages:
- stage: SetupVMs
  jobs:
  - template: templates/nested-parent-vm-setup.yaml
    parameters:
      transportType: amqp
  - template: templates/nested-longhaul-deploy-bottom-layer.yaml
    parameters:
      transportType: amqp
  - template: templates/nested-parent-vm-setup.yaml
    parameters:
      transportType: mqtt
  - template: templates/nested-longhaul-deploy-bottom-layer.yaml
    parameters:
      transportType: mqtt

  - job:  Clean_up      
    dependsOn:
      - SetupVM_level5_amqp
      - SetupVM_level5_mqtt
      - SetupVM_level4_amqp
      - SetupVM_level4_mqtt
      - Deploy_Longhaul_Linux_Amd64_amqp
      - Deploy_Longhaul_Linux_Amd64_mqtt
    condition: eq(variables['test.pipeline'], 'true')
    displayName: Clean up identities and unlock agents
    variables:    
      deviceLvl5AgentName: $[ dependencies.SetupVM_level5.outputs['lock_test_agent.agentName'] ]         
      deviceLvl4AgentName: $[ dependencies.SetupVM_level4.outputs['lock_test_agent.agentName'] ]       
      amd64AgentName: $[ dependencies.Deploy_Longhaul_Linux_Amd64.outputs['lock_test_agent.agentName'] ]  
      arm32AgentName: $[ dependencies.Deploy_Longhaul_Linux_Arm32.outputs['lock_test_agent.agentName'] ]  
      arm64AgentName: $[ dependencies.Deploy_Longhaul_Linux_Arm64.outputs['lock_test_agent.agentName'] ]  
    pool:
      name: $(pool.name)
      demands:
        - agent-group -equals $(agent.group)
        - Agent.OS -equals Linux
        - Agent.OSArchitecture -equals X64
        - status -equals unlocked_$(Build.BuildId)  
    steps:
      - template: templates/nested-get-secrets.yaml     
      - template: templates/unlock-test-agent.yaml 
        parameters:
          agentName: $(deviceLvl5AgentName)
          lvl: 5  
      - template: templates/unlock-test-agent.yaml 
        parameters:
          agentName: $(deviceLvl4AgentName)
          lvl: 4             
      - template: templates/unlock-test-agent.yaml 
        parameters:
          agentName: $(amd64AgentName)
          lvl: 3  
      - template: templates/unlock-test-agent.yaml 
        parameters:
          agentName: $(arm32AgentName)
          lvl: 3  
      - template: templates/unlock-test-agent.yaml 
        parameters:
          agentName: $(arm64AgentName)
          lvl: 3  