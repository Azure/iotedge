trigger: none
pr: none
schedules:
- cron: "0 23 * * 4"
  displayName: Weekly run Thursday night
  branches:
    include:
    - release/1.2
  always: true

variables:
  NugetSecurityAnalysisWarningLevel: warn

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.2'
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: 'release/1.2'

stages:
- stage: SetupVMs
  jobs:
  - template: templates/nested-parent-vm-setup.yaml
    parameters:
      upstream.protocol: amqp
  - template: templates/nested-longhaul-deploy-amd64.yaml
    parameters:
      upstream.protocol: amqp
      testInfo.testName: 'longhaul (nested-non-broker)'
  - template: templates/nested-parent-vm-setup.yaml
    parameters:
      upstream.protocol: mqtt
      test.l4DeploymentFileName: 'nestededge_middleLayer_messaging_mqtt.json'
  - template: templates/nested-longhaul-deploy-amd64.yaml
    parameters:
      upstream.protocol: mqtt
      testInfo.testName: 'longhaul (nested-broker)'

  - job:  Unlock_agents      
    dependsOn:
      - SetupVM_level5_amqp
      - SetupVM_level5_mqtt
      - SetupVM_level4_amqp
      - SetupVM_level4_mqtt
      - Deploy_Longhaul_Linux_Amd64_amqp
      - Deploy_Longhaul_Linux_Amd64_mqtt
    condition: and(or(eq(dependencies.Lock_Nested_Agents_amqp.result, 'succeeded'), eq(dependencies.Lock_Nested_Agents_mqtt.result, 'succeeded')), eq(variables['test.pipeline'], 'true'))
    displayName: Unlock agents
    pool:
      name: $(pool.name)
      demands:
        - agent-group -equals $(agent.group)
        - Agent.OS -equals Linux
        - Agent.OSArchitecture -equals X64
        - status -equals unlocked_$(Build.BuildId)_L3_mqtt
    steps:
      - template: templates/nested-get-secrets.yaml     
      - template: templates/unlock-test-agents.yaml 