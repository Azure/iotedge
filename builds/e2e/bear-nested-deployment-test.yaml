trigger: none
pr: none

variables:
  images.artifact.name.linux: 'core-linux'
  vsts.project: $(System.TeamProjectId)
  #Method 1
  totalTimeMin: 6

stages:
- stage: SetupVM
  jobs:
################################################################################
    - job: SetupVM_job1
################################################################################
      displayName: Setting up across multiple VMs
      condition: ne(variables['agent.group'], '')
      timeoutInMinutes: 180
      variables:
        lvl4IP: tbd
        lvl3_5IP: tbd
        lvl3IP: tbd
      strategy:
        matrix:
          L4:
            testrun.vmTier: L4
            testrun.waitTimeMin: 1
          L3_5:
            testrun.vmTier: L3_5
            testrun.waitTimeMin: 0
          L3:
            testrun.vmTier: L3
            testrun.waitTimeMin: 1
            # BEARWASHERE -- BRB rename

      pool:
        name: $(pool.name)
        demands:
          - agent-group -equals $(agent.group)
          - Agent.OS -equals Linux
          - Agent.OSArchitecture -equals X64
          - run-idle -equals true
          - nested-edge -equals $(testrun.vmTier)

      steps:
        - script: |
            echo "##vso[task.setvariable variable=test;isoutput=true]$(hostname)"
            if [[ "$(testrun.vmTier)" == "L3" ]]; then
              echo "##vso[task.setvariable variable=lvl3IP;isoutput=true]$(hostname)"
            fi

            if [[ "$(testrun.vmTier)" == "L3_5" ]]; then
              echo setting variable for l3.5
              echo "##vso[task.setvariable variable=lvl3_5IP;isoutput=true]$(hostname)"
              #wait L4
            fi

            if [[ "$(testrun.vmTier)" == "L4" ]]; then
              echo "##vso[task.setvariable variable=lvl4IP;isoutput=true]$(hostname)"
            fi
          name: agent_name

        - task: Bash@3
          name: setting_up
          displayName: 'Setting up $(testrun.vmTier)'
          inputs:
            targetType: inline
            script: |
              # Use sleep to pretend it is a setup time
              echo "$(Agent.Name) is sleeping for $(testrun.waitTimeMin)"
              sleep $(testrun.waitTimeMin)m
              echo "$(Agent.Name) is waking up"
        
        #Method 1 -- sleep until it's time
        - script: |
            echo $(agent_name.test) 
            echo $(agent_name.lvl3IP)         
            echo $(agent_name.lvl3_5IP) 
            echo $(agent_name.lvl4IP)

          name: RunTest

        #Method 2 -- Wait until a file is set
      #  - script:  |
      #      until [ -f /tmp/oldSock ]
      #      do
      #          sleep 1
      #      done
      #      echo "Dobby is free"
      #      exit
      #    name: WaitingToBeFreed2

##########################################################################################
