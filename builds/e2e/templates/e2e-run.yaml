parameters:
  EventHubCompatibleEndpoint: '$(TestEventHubCompatibleEndpoint)'
  IotHubConnectionString: '$(TestIotHubConnectionString)'
  test_type: '' 

steps:
- pwsh: |
    $test_type = '${{ parameters.test_type }}'

    # Filter out unstable tests.
    $filter = 'Category!=Unstable'

    if ('$(minimal)' -eq 'true')
    {
      $filter += '&Name~TempSensor'
    }

    if ('$(Agent.Name)'.Contains('centos'))
    {
      $filter += '&Category=CentOsSafe'
    }
    elseif ('$(arch)' -eq 'arm32v7' -Or '$(arch)' -eq 'arm64v8')
    {
      $filter += '&Category!=UnstableOnArm'
    }
    
    if ($test_type -eq 'nestededge_mqtt')
    {
      $filter += '&Category!=SingleNodeOnly'
      $filter += '&Category!=NestedEdgeAmqpOnly'
      $filter += '&Category!=LegacyMqttRequired'
    
      $filter += '&FullyQualifiedName!~Provisioning&FullyQualifiedName!~PriorityQueueModuleToHubMessages&FullyQualifiedName!~SasOutOfScope&FullyQualifiedName!~X509ManualProvision&FullyQualifiedName!~AuthorizationPolicyUpdateTest&FullyQualifiedName!~AuthorizationPolicyExplicitPolicyTest'
    }
    elseif ($test_type -eq 'nestededge_amqp')
    {
      $filter += '&Category!=SingleNodeOnly'
      $filter += '&Category!=BrokerRequired'

      $filter += '&FullyQualifiedName!~Provisioning&FullyQualifiedName!~PriorityQueueModuleToHubMessages&FullyQualifiedName!~SasOutOfScope&FullyQualifiedName!~X509ManualProvision&FullyQualifiedName!~AuthorizationPolicyUpdateTest&FullyQualifiedName!~AuthorizationPolicyExplicitPolicyTest'
    }
    elseif ($test_type -eq 'nestededge_isa95')
    {
      $filter = 'Category=nestededge_isa95'
    }
    elseif ($test_type -eq 'http_proxy')
    {
      #Disable tests that don't work in proxy environment. Renable post-investigation.
      $filter += '&FullyQualifiedName!~PriorityQueue&FullyQualifiedName!~PlugAndPlay&FullyQualifiedName!~ValidateMetrics'

      #Disable tests that timeout in proxy self-host environment
      $filter += '&FullyQualifiedName!~TestGetModuleLogs&FullyQualifiedName!~TestUploadSupportBundle'

      #Disable nested edge tests
      $filter += '&Category!=NestedEdgeOnly'
    }
    else
    {
      $filter += '&Category!=NestedEdgeOnly'
    }

    Write-Output "##vso[task.setvariable variable=dotnetTestFilter]$filter"

    # TODO: remove old test run command
    # sudo --preserve-env dotnet test $testFile --no-build --logger 'trx' --filter "$filter"
  displayName: Find what tests to skip

 # TODO: might need to run with sudo 
- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    projects: '$(binDir)/Microsoft.Azure.Devices.Edge.Test.dll'
    arguments: '--no-build --logger "trx" --filter "$(dotnetTestFilter)"'
  displayName: Run tests ${{ parameters.test_type }}
  continueOneError: true
  env:
    E2E_DPS_GROUP_KEY: $(TestDpsGroupKeySymmetric)
    E2E_EVENT_HUB_ENDPOINT: ${{ parameters['EventHubCompatibleEndpoint'] }}
    E2E_IOT_HUB_CONNECTION_STRING: ${{ parameters['IotHubConnectionString'] }}
    E2E_REGISTRIES__0__PASSWORD: $(TestContainerRegistryPassword)
    E2E_ROOT_CA_PASSWORD: $(TestRootCaPassword)
    E2E_BLOB_STORE_SAS: $(TestBlobStoreSas)

- pwsh: |
    $logDir = '$(Build.ArtifactStagingDirectory)/logs${{ parameters.test_type }}'
    New-Item $logDir -ItemType Directory -Force | Out-Null
    Out-File "$logDir/$(Build.DefinitionName)-$(Build.BuildNumber)"
    Copy-Item "$(Build.SourcesDirectory)/TestResults" "$logDir/" -Recurse
    # The setup fixtures run outside the scope of any test, so their logs (*-[test|device]-*.log)
    # aren't included in the TRX. Copy them manually here.
    Copy-Item "$(binDir)/*-test-*.log" "$logDir/"
    Copy-Item "$(binDir)/*-device-*.log" "$logDir/"
    Copy-Item "$(binDir)/testoutput.log" "$logDir/"
    $artifactSuffix = '$(Build.BuildNumber)-$(System.PhaseName)' -replace '_','-'
    Write-Output "##vso[task.setvariable variable=artifactSuffix]$artifactSuffix"
  displayName: Collect Logs
  condition: succeededOrFailed()

- task: PublishBuildArtifacts@1
  displayName: Publish logs
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)/logs${{ parameters.test_type }}
    ArtifactName: logs-end-to-end-$(artifactSuffix)
  condition: succeededOrFailed()
