parameters:
- name: acrName
  type: string
  default: ''
- name: crossJobVariables
  type: boolean
  default: false
- name: serviceConnection
  type: string
  default: ''

steps:
- task: AzureCLI@2
  name: generate
  displayName: 'Get ACR credentials'
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      server=$(az acr show --name '${{ parameters.acrName }}' --query loginServer --output tsv)
      login=$(az acr login --name '${{ parameters.acrName }}' --expose-token --output json)
      username=$(echo "$login" | jq -r '.username')
      token=$(echo "$login" | jq -r '.accessToken')

      echo "##vso[task.setvariable variable=acrServer;isoutput=${{ parameters.crossJobVariables }}]$server"
      echo "##vso[task.setvariable variable=acrToken;issecret=true;isoutput=${{ parameters.crossJobVariables }}]$token"
      echo "##vso[task.setvariable variable=acrUsername;isoutput=${{ parameters.crossJobVariables }}]$username"
