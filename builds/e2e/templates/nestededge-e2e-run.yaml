parameters:
- name: deviceId
  type: string

steps:
- pwsh: |
    $keyFile = "~/sshkeys/nested${{ parameters.deviceId }}key.pem"
    $deviceAlias = "nesteddevice${{ parameters.deviceId }}"
    
    ssh -i $keyFile $deviceAlias pwsh -Command "$(nestedDeviceTestFolder)/testbin/runtest.ps1"
    
    #mkdir $(nestedDeviceTestFolder)/logs
    #find $(nestedDeviceTestFolder)/testbin -name *.log | xargs cp -t $(nestedDeviceTestFolder)/logs
    #scp -i $keyFile -r ${deviceAlias}:$(nestedDeviceTestFolder)/testresults $(Build.SourcesDirectory)/testresults
    #scp -i $keyFile -r ${deviceAlias}:$(nestedDeviceTestFolder)/logs $(Build.SourcesDirectory)/logs

  displayName: Run tests on nesteddevice${{ parameters.deviceId }}

#- task: PublishTestResults@2
#  displayName: Publish test results
#  inputs:
#    testResultsFormat: vstest
#    testResultsFiles: '**/*.trx'
#    searchFolder: $(Build.SourcesDirectory)/TestResults
#    testRunTitle: End-to-end tests ($(Build.BuildNumber) $(os) $(arch)) on nesteddevice${{ parameters.deviceId }}
#    buildPlatform: $(arch)
#  condition: succeededOrFailed()

#- pwsh: |
#    $logDir = '$(Build.ArtifactStagingDirectory)/logs'
#    New-Item $logDir -ItemType Directory -Force | Out-Null
#    Out-File "$logDir/$(Build.DefinitionName)-$(Build.BuildNumber)"
#    Copy-Item "$(Build.SourcesDirectory)/TestResults" "$logDir/" -Recurse
#    # The setup fixtures run outside the scope of any test, so their logs (*-[test|device]-*.log)
#    # aren't included in the TRX. Copy them manually here.
#    Copy-Item "$(binDir)/*-test-*.log" "$logDir/"
#    Copy-Item "$(binDir)/*-device-*.log" "$logDir/"
#    Copy-Item "$(binDir)/testoutput.log" "$logDir/"
#  displayName: Collect Logs
#  condition: succeededOrFailed()
#
#- task: PublishBuildArtifacts@1
#  displayName: Publish logs
#  inputs:
#    PathtoPublish: $(Build.ArtifactStagingDirectory)/logs
#    ArtifactName: logs-end-to-end-$(Build.BuildNumber)-$(os)-$(arch)
#  condition: succeededOrFailed()
