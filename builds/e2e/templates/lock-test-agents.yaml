parameters:
  upstream.protocol: 'amqp'
  testRunnerCount: '1'

jobs:
  - job: Lock_Nested_Agents_${{ parameters['upstream.protocol'] }}
    displayName: Lock nested agents for ${{ parameters['upstream.protocol'] }}
    timeoutInMinutes: 180
    pool:
      name: $(pool.linux.name)
      demands:
        - ImageOverride -equals agent-aziotedge-ubuntu-22.04-msmoby
    steps:
      - template: nested-get-secrets.yaml
      - task: AzureCLI@2
        condition: always()
        displayName: 'Get PAT'
        inputs:
          azureSubscription: 'IoTEdge1-msazure'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            # Note that the resoruce is specified to limit the token to Azure DevOps
            aadTokenInfo=$(az account get-access-token --resource "499b84ac-1321-427f-aa17-267ca6975798")
            if [ $? -ne 0 ]; then
                echo "Could not acquire Azure DevOps token."
                exit 40
            fi
            echo "Azure DevOps AAD token acquired.  Expires $(echo $aadTokenInfo | jq -r .expiresOn)"
            aadToken=$(echo $aadTokenInfo | jq -r .accessToken)
            echo "##vso[task.setvariable variable=IotEdgePAT;issecret=true]$aadToken"

      - script: scripts/linux/nestedAgentLock.sh -a "$(agent.group)" -b "$(Build.BuildId)" -n ${{ parameters['testRunnerCount'] }} -u ${{ parameters['upstream.protocol'] }}
        env:
          PAT: "$(IotEdgePAT)"
        displayName: Lock agents for nested topology
        name: lock_test_agent
