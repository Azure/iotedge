parameters:
    azureSubscription: ''
    keyVaultName: ''

jobs:
  - job: Token
    displayName: 'Get SAS URI for Blob Storage Account'
    pool:
      name: $(pool.linux.name)
      demands:
        - ImageOverride -equals agent-aziotedge-ubuntu-22.04-msmoby
    steps:
      - task: AzureKeyVault@2
        displayName: Get secrets
        condition: false
        inputs:
          azureSubscription: ${{ parameters.azureSubscription }}
          keyVaultName: ${{ parameters.keyVaultName }}
          secretsFilter: >-
            TestContainerRegistryPassword,
            TestDpsGroupKeySymmetric,
            TestEventHubCompatibleEndpoint,
            TestIotHubConnectionString,
            TestIotHubResourceId,
            TestRootCaCertificate,
            TestRootCaKey,
            TestRootCaPassword
      - bash: |
          # Azure Pipelines doesn't seem to handle multi-line task variables, so encode to one line
          # See https://developercommunity.visualstudio.com/t/multiple-lines-variable-in-build-and-release/365667
          readarray -t certlines < <(echo '$(TestRootCaCertificate)')
          cert=$(printf '\\x0A%s' "${certlines[@]//$'\r'}") # Prepend each line with hex-escaped newline
          cert=${cert:4} # Remove leading newline

          # Azure Pipelines doesn't seem to handle multi-line task variables, so encode to one line
          # See https://developercommunity.visualstudio.com/t/multiple-lines-variable-in-build-and-release/365667
          readarray -t keylines < <(echo '$(TestRootCaKey)')
          key=$(printf '\\x0A%s' "${keylines[@]//$'\r'}") # Prepend each line with hex-escaped newline
          key=${key:4} # Remove leading newline

          echo "##vso[task.setvariable variable=containerRegistryPassword;issecret=true;isoutput=true]$(TestContainerRegistryPassword)"
          echo "##vso[task.setvariable variable=dpsGroupKeySymmetric;issecret=true;isoutput=true]$(TestDpsGroupKeySymmetric)"
          echo "##vso[task.setvariable variable=eventHubCompatibleEndpoint;issecret=true;isoutput=true]$(TestEventHubCompatibleEndpoint)"
          echo "##vso[task.setvariable variable=iotHubConnectionString;issecret=true;isoutput=true]$(TestIotHubConnectionString)"
          echo "##vso[task.setvariable variable=iotHubResourceId;issecret=false;isoutput=true]$(TestIotHubResourceId)"
          echo "##vso[task.setvariable variable=rootCaCertificate;issecret=true;isoutput=true]$cert"
          echo "##vso[task.setvariable variable=rootCaKey;issecret=true;isoutput=true]$key"
          echo "##vso[task.setvariable variable=rootCaPassword;issecret=true;isoutput=true]$(TestRootCaPassword)"
        name: secrets
        displayName: 'Make Key Vault secrets available to pipeline'
      - task: AzureCLI@2
        name: generate
        displayName: 'Get Storage URI'
        inputs:
          azureSubscription: ${{ parameters.azureSubscription }}
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            # Hardcoded resource group and storage account name
            resource_group="EdgeBuilds"
            storage_account="e2eteststorageedge"
            # Set container name with name of storage account container
            container_name="e2etest"
            # Set expiry time for the SAS token
            expiry_time=$(date --utc --date "+2 days" +"%Y-%m-%dT%H:%MZ")
            # Generate the SAS token for the container
            sasToken=$(az storage container generate-sas --account-name "$storage_account" --name "$container_name" --https-only --expiry "$expiry_time" --as-user --auth-mode login --permissions drwl --output tsv)
            if [ $? -ne 0 ]; then
              echo "Failed to generate SAS token."
              exit 1
            fi
            echo "SAS token for Azure Storage account acquired.  Expires $expiry_time"
            # Construct the SAS URI
            endpoint=$(az storage account show --name "$storage_account" --resource-group "$resource_group" --query 'primaryEndpoints.blob' -o tsv)
            sas_uri="$endpoint$container_name?$sasToken"
            echo "##vso[task.setvariable variable=sas_uri;issecret=true;isoutput=true]$sas_uri"
