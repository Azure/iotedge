parameters:
- name: deviceId
  type: string
  
steps:
- pwsh: |
    $keyFile = "~/sshkeys/nested${{ parameters.deviceId }}key.pem"
    $deviceAlias = "nesteddevice${{ parameters.deviceId }}"

    Write-Output "Nested device test foler=$(nestedDeviceTestFolder) on $deviceAlias"
    ssh -i $keyFile $deviceAlias sudo rm -rf $(nestedDeviceTestFolder)

    ssh -i $keyFile $deviceAlias mkdir -p $(nestedDeviceTestFolder)/testproject
    scp -i $keyFile -r $(testProjectDir)/* ${deviceAlias}:$(nestedDeviceTestFolder)/testproject
    ssh -i $keyFile $deviceAlias mkdir -p $(nestedDeviceTestFolder)/certs
    scp -i $keyFile -r $(certsDir)/* ${deviceAlias}:$(nestedDeviceTestFolder)/certs
    ssh -i $keyFile $deviceAlias mkdir -p $(nestedDeviceTestFolder)/artifacts
    scp -i $keyFile -r $(System.ArtifactsDirectory)/* ${deviceAlias}:$(nestedDeviceTestFolder)/artifacts
    ssh -i $keyFile $deviceAlias mkdir -p $(nestedDeviceTestFolder)/tools
    scp -i $keyFile -r $(Build.SourcesDirectory)/tools/* ${deviceAlias}:$(nestedDeviceTestFolder)/tools

  displayName: Copy test files to nesteddevice${{ parameters.deviceId }}