parameters:
  release.Label: ''
  edgelet.artifact.name: ''
  images.artifact.name: ''
  container.registry: ''
  container.registry.credential: ''
  iotHub.connectionString: ''
  eventHub.connectionString: ''
  snitch.build.number: ''
  snitch.alert.url: ''
  snitch.storage.account: ''
  snitch.storage.masterKey: ''
  loadGen.message.frequency: ''
  loadGen.transportType: 'mqtt'
  longHaul.protocolHead: ''

steps:
  - task: CopyFiles@2
    displayName: 'Copy Edgelet Artifact'
    inputs:
      SourceFolder: '$(System.ArtifactsDirectory)/$(edgelet.artifact.name)'
      TargetFolder: '$(Agent.HomeDirectory)/../artifacts/$(edgelet.artifact.name)'
      CleanTargetFolder: true
  - task: CopyFiles@2
    displayName: 'Copy Images artifact'
    inputs:
      SourceFolder: '$(System.ArtifactsDirectory)/$(images.artifact.name)'
      TargetFolder: '$(Agent.HomeDirectory)/../artifacts/$(images.artifact.name)'
      CleanTargetFolder: true
  - task: PowerShell@3
    displayName: 'Run Long Haul Deployment'
    inputs:
      targetType: inline
      script: |
        cnreg=$(parameters['container.registry.credential'])
        testName="LongHaul"
        $(Agent.HomeDirectory)/../artifacts/${{ parameters['images.artifact.name'] }}/scripts/windows/test/runE2ETest.ps1 -E2ETestFolder "$(Agent.HomeDirectory)/.." -ReleaseLabel "${{ parameters['release.label'] }}" -ArtifactImageBuildNumber "$BuildNumber" -TestName "$testName" -ContainerRegistry "${{ parameters['container.registry'] }}" -ContainerRegistryUsername "${cnreg[0]}" -ContainerRegistryPassword "${cnreg[1]}" -IoTHubConnectionString "${{ parameters['iotHub.connectionString'] }}" -EventHubConnectionString "${{ parameters['eventHub.connectionString'] }}" -SnitchBuildNumber "${{ parameters['snitch.build.number'] }}" -SnitchStorageAccount "${{ parameters['snitch.storage.account'] }}" -SnitchStorageMasterKey "${{ parameters['snitch.storage.masterKey'] }}" -SnitchAlertUrl "${{ parameters['snitch.alert.url'] }}" -LoadGenMessageFrequency "${{ parameters['loadGen.message.frequency'] }}" -LongHaulProtocolHead "${{ parameters['longHaul.protocolHead'] }}"
      workingDirectory: "$(Agent.HomeDirectory)/.."