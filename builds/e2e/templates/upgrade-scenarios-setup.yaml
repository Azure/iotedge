parameters:
  useArtifactInfoFile: 'False'
  artifactBranch: ''
  updateRuntimeImages: 'False'
  edgeAgentImageTag: ''
  edgeHubImageTag: ''
  updateBootstrapAgentImage: 'False'
  bootstrapAgentImageTag: ''
  project: ''
  pipeline: ''
  buildId: ''

steps:
- task: DownloadBuildArtifacts@0
  condition: eq('${{ parameters.useArtifactInfoFile }}', 'True')
  displayName: Download ${{ parameters['artifactBranch'] }} artifactInfo.txt
  inputs:
    buildType: specific
    project: ${{ parameters['project'] }}
    pipeline: ${{ parameters['pipeline'] }} 
    buildVersionToDownload: specific
    buildId: ${{ parameters['buildId'] }}
    downloadType: single
    artifactName: $(az.pipeline.images.artifacts)
    itemPattern: $(az.pipeline.images.artifacts)/artifactInfo.txt

- bash: |
    bootstrapAgentTag=${{ parameters['bootstrapAgentImageTag'] }}
    edgeAgentTag=${{ parameters['edgeAgentImageTag'] }}
    edgeHubTag=${{ parameters['edgeHubImageTag'] }}
    if [ ${{ parameters['useArtifactInfoFile'] }} = 'True' ]; then
      artifactInfoStr=`cat '$(System.ArtifactsDirectory)/$(az.pipeline.images.artifacts)/artifactInfo.txt'`
      IFS='='
      read -ra artifactInfo <<< "$artifactInfoStr"
      bootstrapAgentTag="${artifactInfo[1]}"
      edgeAgentTag="${artifactInfo[1]}"
      edgeHubTag="${artifactInfo[1]}"
    fi
    cd $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/net*
    echo "Original context.json:"
    less context.json
    if [ ${{ parameters['updateRuntimeImages'] }} = 'True' ]; then
        sed -i 's/"edgeHubImage.*/"edgeHubImage": "edgebuilds.azurecr.io\/microsoft\/azureiotedge-hub:'${edgeHubTab}'",/' context.json
        sed -i 's/"edgeAgentImage.*/"edgeAgentImage": "edgebuilds.azurecr.io\/microsoft\/azureiotedge-agent:'${edgeAgentTag}'",/' context.json
    fi
    if [ ${{ parameters['updateBootstrapAgentImage'] }}  = 'True' ]; then
      sed -i 's/"edgeAgentBootstrapImage.*/"edgeAgentBootstrapImage": "edgebuilds.azurecr.io\/microsoft\/azureiotedge-agent:'${bootstrapAgentTag}'",/' context.json    
    fi
    echo "Updated context.json:"
    less context.json
  condition: or(eq('${{ parameters.updateRuntimeImages }}', 'True'), eq('${{ parameters.updateBootstrapAgentImage }}', 'True'))
  displayName: Update context.json w/ ${{ parameters['artifactBranch'] }} Tags