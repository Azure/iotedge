parameters:
- name: configurations
  type: object
  default:
  - name: azurelinux
    versions:
    - version: 3
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-azurelinux-3.0-msmoby
        artifact:
          edge: iotedged-azurelinux3-amd64
          identity: aziot-identity-azurelinux3-amd64
        pool: $(pool.linux.name)
      - arch: arm64v8
        agentImage: agent-aziotedge-azurelinux-3.0-arm64-msmoby
        artifact:
          edge: iotedged-azurelinux3-aarch64
          identity: aziot-identity-azurelinux3-aarch64
        pool: $(pool.linux.arm64.name)
  - name: debian
    versions:
    - version: 11
      targets:
      - arch: arm32v7
        agentDemand: deb11-e2e-tests
        artifact:
          edge: iotedged-debian11-arm32v7
          identity: aziot-identity-debian11-arm32v7
        minimal: true
        pool: $(pool.custom.name)
    - version: 12
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-debian-12-msmoby
        artifact:
          edge: iotedged-debian12-amd64
          identity: aziot-identity-debian12-amd64
        pool: $(pool.linux.name)
      - arch: arm64v8
        agentImage: agent-aziotedge-debian-12-arm64-msmoby
        artifact:
          edge: iotedged-debian12-aarch64
          identity: aziot-identity-debian12-aarch64
        pool: $(pool.linux.arm64.name)
      - arch: arm32v7
        agentDemand: deb12-e2e-tests
        artifact:
          edge: iotedged-debian12-arm32v7
          identity: aziot-identity-debian12-arm32v7
        pool: $(pool.custom.name)
  - name: redhat
    versions:
    - version: 8
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-rhel-8-msmoby
        artifact:
          edge: iotedged-redhat8-amd64
          identity: aziot-identity-redhat8-amd64
        pool: $(pool.linux.name)
    - version: 9
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-rhel-9-msmoby
        artifact:
          edge: iotedged-redhat9-amd64
          identity: aziot-identity-redhat9-amd64
        pool: $(pool.linux.name)
  - name: ubuntu
    versions:
    - version: 2204
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-ubuntu-22.04-msmoby
        artifact:
          edge: iotedged-ubuntu22.04-amd64
          identity: aziot-identity-ubuntu22.04-amd64
        pool: $(pool.linux.name)
      - arch: arm64v8
        agentImage: agent-aziotedge-ubuntu-22.04-arm64-msmoby
        artifact:
          edge: iotedged-ubuntu22.04-aarch64
          identity: aziot-identity-ubuntu22.04-aarch64
        pool: $(pool.linux.arm64.name)
    - version: 2404
      targets:
      - arch: amd64
        agentImage: agent-aziotedge-ubuntu-24.04-msmoby
        artifact:
          edge: iotedged-ubuntu24.04-amd64
          identity: aziot-identity-ubuntu24.04-amd64
        pool: $(pool.linux.name)
      - arch: arm64v8
        agentImage: agent-aziotedge-ubuntu-24.04-arm64-msmoby
        artifact:
          edge: iotedged-ubuntu24.04-aarch64
          identity: aziot-identity-ubuntu24.04-aarch64
        pool: $(pool.linux.arm64.name)
  - name: snap
    versions:
    - version: latest
      targets:
      - arch: x64
        agentImage: agent-aziotedge-ubuntu-22.04
        artifact:
          edge: iotedged-snap-amd64
          identity: aziot-identity-snap-amd64
        pool: $(pool.linux.name)
      - arch: arm64
        agentImage: agent-aziotedge-ubuntu-22.04-arm64
        artifact:
          edge: iotedged-snap-aarch64
          identity: aziot-identity-snap-aarch64
        pool: $(pool.linux.arm64.name)
  - name: proxy
    versions:
    - version: latest
      targets:
      - arch: amd64
        agentDemand: new-e2e-proxy
        artifact:
          edge: iotedged-ubuntu24.04-amd64
          identity: aziot-identity-ubuntu24.04-amd64
        pool: $(pool.custom.name)

jobs:
- ${{ each config in parameters.configurations }}:
  - ${{ each version in config.versions }}:
    - ${{ each target in version.targets }}:
      - job: ${{ format('{0}_{1}_{2}', config.name, version.version, target.arch) }}
        displayName: ${{ format('{0} {1} {2}', config.name, version.version, target.arch) }}
        dependsOn: Token
        condition: succeeded('Token')

        pool:
          name: ${{ target.pool }}
          demands:
          - ${{ coalesce(target.agentDemand, format('ImageOverride -equals {0}', target.agentImage)) }}

          variables:
            os: linux
            arch: ${{ target.arch }}
            identityArtifactName: ${{ target.artifact.identity }}
            artifactName: ${{ target.artifact.edge }}
            containerRegistryPassword: $[ dependencies.Token.outputs['secrets.containerRegistryPassword'] ]
            dpsGroupKeySymmetric: $[ dependencies.Token.outputs['secrets.dpsGroupKeySymmetric'] ]
            eventHubCompatibleEndpoint: $[ dependencies.Token.outputs['secrets.eventHubCompatibleEndpoint'] ]
            iotHubConnectionString: $[ dependencies.Token.outputs['secrets.iotHubConnectionString'] ]
            iotHubResourceId: $[ dependencies.Token.outputs['secrets.iotHubResourceId'] ]
            rootCaCertificate: $[ dependencies.Token.outputs['secrets.rootCaCertificate'] ]
            rootCaKey: $[ dependencies.Token.outputs['secrets.rootCaKey'] ]
            rootCaPassword: $[ dependencies.Token.outputs['secrets.rootCaPassword'] ]
            sas_uri: $[ dependencies.Token.outputs['generate.sas_uri'] ]
            minimal: ${{ coalesce(target.minimal, false) }}

          ${{ if and(eq(target.arch, 'arm32v7'), eq(target.minimal, false)) }}:
            timeoutInMinutes: 90

          steps:
          - ${{ if eq(config.name, 'snap') }}:
            - script: |
                sudo snap install docker
              displayName: Install Docker as a snap
          - ${{ if eq(target.pool, parameters.pool.custom) }}:
            - template: templates/e2e-clean-directory.yaml
          - template: e2e-setup.yaml
            parameters:
              iotHubResourceId: '$(iotHubResourceId)'
              rootCaCertificate: '$(rootCaCertificate)'
              rootCaKey: '$(rootCaKey)'
          - ${{ if eq(target.pool, parameters.pool.custom) }}:
            - template: templates/e2e-clear-docker-cached-images.yaml
          - template: e2e-run.yaml
            parameters:
              containerRegistryPassword: '$(containerRegistryPassword)'
              dpsGroupKeySymmetric: '$(dpsGroupKeySymmetric)'
              eventHubCompatibleEndpoint: '$(eventHubCompatibleEndpoint)'
              iotHubConnectionString: '$(iotHubConnectionString)'
              rootCaPassword: '$(rootCaPassword)'
              sas_uri: $(sas_uri)
              ${{ if eq(config.name, 'proxy') }}:
                test_type: http_proxy
