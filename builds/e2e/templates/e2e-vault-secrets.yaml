parameters:
  azureSubscription: ''
  keyVaultName: ''

steps:
  - task: AzureKeyVault@2
    displayName: Get secrets
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      keyVaultName: ${{ parameters.keyVaultName }}
      secretsFilter: >-
        TestContainerRegistryPassword,
        TestDpsGroupKeySymmetric,
        TestEventHubCompatibleEndpoint,
        TestIotHubConnectionString,
        TestIotHubResourceId,
        TestRootCaCertificate,
        TestRootCaKey,
        TestRootCaPassword
  - bash: |
      # Azure Pipelines doesn't seem to handle multi-line task variables, so encode to one line
      # See https://developercommunity.visualstudio.com/t/multiple-lines-variable-in-build-and-release/365667
      readarray -t certlines < <(echo '$(TestRootCaCertificate)')
      cert=$(printf '\\x0A%s' "${certlines[@]//$'\r'}") # Prepend each line with hex-escaped newline
      cert=${cert:4} # Remove leading newline

      # Azure Pipelines doesn't seem to handle multi-line task variables, so encode to one line
      # See https://developercommunity.visualstudio.com/t/multiple-lines-variable-in-build-and-release/365667
      readarray -t keylines < <(echo '$(TestRootCaKey)')
      key=$(printf '\\x0A%s' "${keylines[@]//$'\r'}") # Prepend each line with hex-escaped newline
      key=${key:4} # Remove leading newline

      echo "##vso[task.setvariable variable=containerRegistryPassword;issecret=true;isoutput=true]$(TestContainerRegistryPassword)"
      echo "##vso[task.setvariable variable=dpsGroupKeySymmetric;issecret=true;isoutput=true]$(TestDpsGroupKeySymmetric)"
      echo "##vso[task.setvariable variable=eventHubCompatibleEndpoint;issecret=true;isoutput=true]$(TestEventHubCompatibleEndpoint)"
      echo "##vso[task.setvariable variable=iotHubConnectionString;issecret=true;isoutput=true]$(TestIotHubConnectionString)"
      echo "##vso[task.setvariable variable=iotHubResourceId;issecret=false;isoutput=true]$(TestIotHubResourceId)"
      echo "##vso[task.setvariable variable=rootCaCertificate;issecret=true;isoutput=true]$cert"
      echo "##vso[task.setvariable variable=rootCaKey;issecret=true;isoutput=true]$key"
      echo "##vso[task.setvariable variable=rootCaPassword;issecret=true;isoutput=true]$(TestRootCaPassword)"
    name: secrets
    displayName: 'Make Key Vault secrets available to pipeline'
