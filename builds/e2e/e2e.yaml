# End-to-end tests should run after new docker images are built, but 'build
# completion triggers' are not yet supported in YAML. Set to 'none' here
# and override in the online editor.
trigger: none
pr: none
jobs:

# ################################################################################
#   - job: linux_amd64
# ################################################################################
#     displayName: Linux amd64
#     pool:
#       vmImage: ubuntu-16.04
#     steps:

#     - checkout: self
#       fetchDepth: 100

#     - task: AzureKeyVault@1
#       displayName: Get secrets
#       inputs:
#         azureSubscription: $(az.subscription)
#         keyVaultName: $(kv.name)
#         secretsFilter: >-
#           TestContainerRegistryPassword,
#           TestEventHubCompatibleEndpoint,
#           TestIotHubConnectionString,
#           TestRootCaCertificate,
#           TestRootCaKey,
#           TestRootCaPassword

#     - script: |
#         if [ '$(az.pipeline.packages.buildId)' == '' ]; then
#           echo '##vso[task.setvariable variable=whichVersion]latestFromBranch'
#         else
#           echo '##vso[task.setvariable variable=whichVersion]specific'
#         fi
#       displayName: Locate iotedged packages

#     - task: DownloadBuildArtifacts@0
#       displayName: Download iotedged packages
#       inputs:
#         buildType: specific
#         project: one
#         pipeline: $(az.pipeline.packages)
#         buildVersionToDownload: $(whichVersion)
#         branchName: refs/heads/master
#         buildId: $(az.pipeline.packages.buildId)
#         downloadType: specific
#         itemPattern: iotedged-ubuntu-amd64/*.deb

#     - script: |
#         testDir='$(Pipeline.Workspace)/e2e'
#         mkdir -p "$testDir/certs"
#         printf '%s' "$ROOT_CERT" > "$testDir/certs/rsa_root_ca.cert.pem"
#         printf '%s' "$ROOT_KEY" > "$testDir/certs/rsa_root_ca.key.pem"
#       displayName: Install CA keys
#       env:
#         ROOT_CERT: $(TestRootCaCertificate)
#         ROOT_KEY: $(TestRootCaKey)

#     - script: |
#         imageId='$(az.pipeline.images.buildNum)'
#         if [ -z $imageId ]; then
#           imageId='$(Build.TriggeredBy.BuildNumber)'
#         fi
#         if [ -z $imageId ]; then
#           echo 'Build not triggered by the "Build Images" build, and argument "az.pipeline.images.buildNum" not specified'
#         fi

#         binDir='$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/netcoreapp2.1'
#         testDir='$(Pipeline.Workspace)/e2e'
#         imagePrefix='$(cr.address)/$(cr.labelPrefix)azureiotedge'
#         imageTag="$imageId-linux-amd64"

#         mkdir -p "$binDir"

#         > "$binDir/context.json" cat <<-EOF
#         {
#           "edgeAgentImage": "$imagePrefix-agent:$imageTag",
#           "edgeHubImage": "$imagePrefix-hub:$imageTag",
#           "tempSensorImage": "$imagePrefix-simulated-temperature-sensor:$imageTag",
#           "methodSenderImage": "$imagePrefix-direct-method-sender:$imageTag",
#           "methodReceiverImage": "$imagePrefix-direct-method-receiver:$imageTag",
#           "registries": [
#             {
#               "address": "$(cr.address)",
#               "username": "$(cr.username)"
#             }
#           ],
#           "packagePath": "$(System.ArtifactsDirectory)/iotedged-ubuntu-amd64",
#           "caCertScriptPath": "$(Build.SourcesDirectory)/tools/CACertificates",
#           "rootCaCertificatePath": "$testDir/certs/rsa_root_ca.cert.pem",
#           "rootCaPrivateKeyPath": "$testDir/certs/rsa_root_ca.key.pem",
#           "logFile": "$binDir/testoutput.log"
#         }
#         EOF
#       displayName: Create test arguments file (context.json)

#     - script: |
#         sudo --preserve-env \
#           dotnet test --logger:trx $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test
#       displayName: Run tests
#       env:
#         E2E_EVENT_HUB_ENDPOINT: $(TestEventHubCompatibleEndpoint)
#         E2E_IOT_HUB_CONNECTION_STRING: $(TestIotHubConnectionString)
#         E2E_REGISTRIES__0__PASSWORD: $(TestContainerRegistryPassword)
#         E2E_ROOT_CA_PASSWORD: $(TestRootCaPassword)

#     - task: PublishTestResults@2
#       displayName: Publish test results
#       inputs:
#         testResultsFormat: vstest
#         testResultsFiles: '**/*.trx'
#         searchFolder: $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test
#         testRunTitle: End-to-end tests ($(Build.BuildNumber))
#         buildPlatform: Linux amd64
#       condition: succeededOrFailed()

#     - script: |
#         binDir='$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/netcoreapp2.1'
#         logDir='$(System.ArtifactsDirectory)/logs'
#         mkdir -p "$logDir"
#         echo > "$logDir/$(Build.DefinitionName)-$(Build.BuildNumber)"
#         cp -r "$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/TestResults" "$logDir/"
#         # The setup fixture runs outside the scope of any test, so its logs (*-test-*.log) aren't
#         # included in the TRX. Copy them manually here.
#         cp "$binDir/"*-test-*.log "$logDir/"
#         cp "$binDir/testoutput.log" "$logDir/"
#       displayName: Collect Logs
#       condition: succeededOrFailed()

#     - task: PublishBuildArtifacts@1
#       displayName: Publish logs
#       inputs:
#         PathtoPublish: $(System.ArtifactsDirectory)/logs
#         ArtifactName: logs-end-to-end-$(Build.BuildNumber)
#       condition: succeededOrFailed()

################################################################################
  - job: end_to_end_tests
################################################################################
    displayName: End-to-end tests
    strategy:
      matrix:
        Linux-amd64:
          os: linux
          arch: amd64
          vmImage: ubuntu-16.04
          artifactDir: iotedged-ubuntu-amd64
        Windows-amd64:
          os: windows
          arch: amd64
          vmImage: windows-2019
          artifactDir: iotedged-windows
    pool:
      vmImage: $(vmImage)
    steps:

    - checkout: self
      fetchDepth: 100

    - task: AzureKeyVault@1
      displayName: Get secrets
      inputs:
        azureSubscription: $(az.subscription)
        keyVaultName: $(kv.name)
        secretsFilter: >-
          TestContainerRegistryPassword,
          TestEventHubCompatibleEndpoint,
          TestIotedgedPackageRootSigningCert,
          TestIotHubConnectionString,
          TestRootCaCertificate,
          TestRootCaKey,
          TestRootCaPassword

    - pwsh: |
        $certBytes = [system.Text.Encoding]::UTF8.GetBytes($env:PACKAGE_SIGNING_CERT)
        $cert = [System.Security.Cryptography.X509Certificates.X509Certificate]::new($certBytes)
        $store = New-Object System.Security.Cryptography.X509Certificates.X509Store `
          -ArgumentList 'Root', 'LocalMachine'
        $store.Open('ReadWrite')
        $store.Add($cert)
      displayName: (Windows) Install CAB signing root cert
      env:
        PACKAGE_SIGNING_CERT: $(TestIotedgedPackageRootSigningCert)
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

    - pwsh: |
        Write-Output '>>> BEFORE:'
        netsh interface ipv6 show prefixpolicies
        netsh interface ipv6 set prefixpolicy ::ffff:0:0/96 45 4
        Write-Output '>>> AFTER:'
        netsh interface ipv6 show prefixpolicies
      displayName: (Windows) Prefer IPv4
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

    - pwsh: |
        if (-not '$(az.pipeline.packages.buildId)')
        {
          Write-Output '##vso[task.setvariable variable=whichVersion]latestFromBranch'
        }
        else
        {
          Write-Output '##vso[task.setvariable variable=whichVersion]specific'
        }
      displayName: Locate iotedged packages

    - task: DownloadBuildArtifacts@0
      displayName: Download iotedged packages
      inputs:
        buildType: specific
        project: one
        pipeline: $(az.pipeline.packages)
        buildVersionToDownload: $(whichVersion)
        branchName: refs/heads/master
        buildId: $(az.pipeline.packages.buildId)
        downloadType: specific
        itemPattern: $(artifactDir)/*

    - pwsh: |
        $testDir = '$(Pipeline.Workspace)/e2e'
        New-Item "$testDir/certs" -ItemType Directory -Force | Out-Null
        $env:ROOT_CERT | Out-File -Encoding Utf8 "$testDir/certs/rsa_root_ca.cert.pem"
        $env:ROOT_KEY | Out-File -Encoding Utf8 "$testDir/certs/rsa_root_ca.key.pem"
      displayName: Install CA keys
      env:
        ROOT_CERT: $(TestRootCaCertificate)
        ROOT_KEY: $(TestRootCaKey)

    - pwsh: |
        $imageId = '$(az.pipeline.images.buildNum)'
        if (-not $imageId)
        {
          $imageId = '$(Build.TriggeredBy.BuildNumber)'
        }
        if (-not $imageId)
        {
          Write-Output 'Build not triggered by the "Build Images" build, and argument "az.pipeline.images.buildNum" not specified'
          return 1
        }

        $binDir = '$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/netcoreapp2.1'
        $testDir = '$(Pipeline.Workspace)/e2e'
        $imagePrefix = '$(cr.address)/$(cr.labelPrefix)azureiotedge'
        $imageTag = "$imageId-$(os)-$(arch)"
        $context = @{
          edgeAgentImage = "$imagePrefix-agent:$imageTag";
          edgeHubImage = "$imagePrefix-hub:$imageTag";
          tempSensorImage = "$imagePrefix-simulated-temperature-sensor:$imageTag";
          methodSenderImage = "$imagePrefix-direct-method-sender:$imageTag";
          methodReceiverImage = "$imagePrefix-direct-method-receiver:$imageTag";
          registries = @(
            @{
              address = '$(cr.address)';
              username = '$(cr.username)';
            }
          );
          packagePath = $(Convert-Path '$(System.ArtifactsDirectory)/$(artifactDir)');
          caCertScriptPath = $(Convert-Path '$(Build.SourcesDirectory)/tools/CACertificates');
          rootCaCertificatePath = $(Convert-Path "$testDir/certs/rsa_root_ca.cert.pem");
          rootCaPrivateKeyPath = $(Convert-Path "$testDir/certs/rsa_root_ca.key.pem");
          logFile = $(Join-Path $binDir 'testoutput.log');
        }

        if ($IsWindows)
        {
          $context['installerPath'] = $(Convert-Path '$(Build.SourcesDirectory)/scripts/windows/setup')
        }

        New-Item $binDir -ItemType Directory -Force | Out-Null
        $context | ConvertTo-Json | Out-File -Encoding Utf8 "$binDir/context.json"
      displayName: Create test arguments file (context.json)

    - pwsh: |
        if ($IsWindows)
        {
          $edgeDir = Join-Path $env:ProgramFiles 'iotedge'
          $mobyDir = Join-Path $env:ProgramFiles 'iotedge-moby'
          $env:Path = "$env:Path;$edgeDir;$mobyDir"
          dotnet test --logger:trx '$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test'
        }
        else
        {
          sudo --preserve-env `
            dotnet test --logger:trx '$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test'
        }
      displayName: Run tests
      env:
        E2E_EVENT_HUB_ENDPOINT: $(TestEventHubCompatibleEndpoint)
        E2E_IOT_HUB_CONNECTION_STRING: $(TestIotHubConnectionString)
        E2E_REGISTRIES__0__PASSWORD: $(TestContainerRegistryPassword)
        E2E_ROOT_CA_PASSWORD: $(TestRootCaPassword)

    - task: PublishTestResults@2
      displayName: Publish test results
      inputs:
        testResultsFormat: vstest
        testResultsFiles: '**/*.trx'
        searchFolder: $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test
        testRunTitle: End-to-end tests ($(Build.BuildNumber))
        buildPlatform: $(os) $(arch)
      condition: succeededOrFailed()

    - pwsh: |
        $binDir = '$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/netcoreapp2.1'
        $logDir = '$(System.ArtifactsDirectory)/logs'
        New-Item $logDir -ItemType Directory -Force | Out-Null
        Out-File "$logDir/$(Build.DefinitionName)-$(Build.BuildNumber)"
        Copy-Item "$(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/TestResults" "$logDir/" -Recurse
        # The setup fixture runs outside the scope of any test, so its logs (*-test-*.log) aren't
        # included in the TRX. Copy them manually here.
        Copy-Item "$binDir/*-test-*.log" "$logDir/"
        Copy-Item "$binDir/testoutput.log" "$logDir/"
      displayName: Collect Logs
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: Publish logs
      inputs:
        PathtoPublish: $(System.ArtifactsDirectory)/logs
        ArtifactName: logs-end-to-end-$(Build.BuildNumber)
      condition: succeededOrFailed()
