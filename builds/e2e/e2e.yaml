trigger: none
pr: none

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.2'
    trigger:
      branches:
      - main
      - release/*
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: 'release/1.2'
    trigger:
      branches:
      - main
      - release/*

variables:
  # A 'minimal' pipeline only runs one end-to-end test (TempSensor). This is useful for platforms or
  # environments that are very similar to other platforms/environments in our matrix, Ubuntu 18.04
  # with the 'docker-ce' package vs. Ubuntu 18.04 with the 'iotedge-moby' package vs. the same
  # variations in Ubuntu 20.04. In these instances the platforms/environments are so similar that we
  # don't reasonably expect to encounter differences--if we do, it would likely manifest during
  # installation, or in running a very basic test. We don't need to repeat the entire test suite.
  # The 'minimal' variable defaults to 'false'; we override it in specific jobs as needed.
  minimal: false
  verbose: false

jobs:
################################################################################
  - job: EFLOW_amd64
################################################################################
    displayName: EFLOW amd64
    condition: eq(variables['run.EFLOW.amd64'], 'true')
    pool:
      name: $(pool.custom.name)
      demands:
        - Agent.OS -equals Linux
        - Agent.OSArchitecture -equals X64
        - run-new-e2e-tests-eflow -equals true
        - eflow -equals true
        - eflow-version -equals 1.2

    variables:
      os: linux
      arch: amd64
      artifactName: iotedged-mariner-amd64
      identityServiceArtifactName: packages_mariner_amd64
      identityServicePackageFilter: aziot-identity-service-*.x86_64.rpm

    timeoutInMinutes: 90

    steps:
    - template: templates/e2e-clean-directory.yaml
    - template: templates/e2e-setup.yaml
    - template: templates/e2e-clear-docker-cached-images.yaml
    - template: templates/e2e-run.yaml
