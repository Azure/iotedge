trigger: none
pr: none

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.1'
    trigger:
      branches:
      - release/1.1
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: 'release/1.1'
    trigger:
      branches:
      - release/1.1
  - pipeline: images_main
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'main'
  - pipeline: images_release_1_2
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.2'    

jobs:
################################################################################
  - job: partial_upgrade_ubuntu_1804_msmoby
################################################################################
    displayName: Partial Upgrade

    pool:
      name: $(pool.linux.name)
      demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-msmoby

    variables:
      os: linux
      arch: amd64
      artifactName: iotedged-ubuntu18.04-amd64
      identityServiceArtifactName: packages_ubuntu-18.04_amd64
      identityServicePackageFilter: aziot-identity-service_*_amd64.deb
      minimal: true

    strategy:
      matrix:
        1.1_to_1.3_no_edge_daemon:
          edgeDaemonVersion: 'release/1.1'
          bootstrapAgentVersion: 'main'
          runtimeModulesVersion: 'main'
        1.1_to_1.3_no_runtime_modules:
          edgeDaemonVersion: 'release/1.1'
          bootstrapAgentVersion: 'release/1.1'
          runtimeModulesVersion: 'main'
        1.1_to_1.2_no_edge_daemon:
          edgeDaemonVersion: 'release/1.1'
          bootstrapAgentVersion: 'release/1.2'
          runtimeModulesVersion: 'release/1.2'
        1.1_to_1.2_only_runtime_modules:
          edgeDaemonVersion: 'release/1.1'
          bootstrapAgentVersion: 'release/1.1'
          runtimeModulesVersion: 'release/1.2'
        1.1.0_to_1.3_no_edge_daemon:
          edgeDaemonVersion: '1.1.0'
          bootstrapAgentVersion: 'main'
          runtimeModulesVersion: 'main'
        1.1.0_to_1.3_only_runtime_modules:
          edgeDaemonVersion: '1.1.0'
          bootstrapAgentVersion: '1.1.0'
          runtimeModulesVersion: 'main'
        1.1.8_to_1.3_no_edge_daemon:
          edgeDaemonVersion: '1.1.8'
          bootstrapAgentVersion: 'main'
          runtimeModulesVersion: 'main'
        1.1.8_to_1.3_only_runtime_modules:
          edgeDaemonVersion: '1.1.8'
          bootstrapAgentVersion: '1.1.8'
          runtimeModulesVersion: 'main'
        1.1.13_to_1.3_no_edge_daemon:
          edgeDaemonVersion: '1.1.13'
          bootstrapAgentVersion: 'main'
          runtimeModulesVersion: 'main'
        1.1.13_to_1.3_only_runtime_modules:
          edgeDaemonVersion: '1.1.13'
          bootstrapAgentVersion: '1.1.13'
          runtimeModulesVersion: 'main'

    timeoutInMinutes: 90

    steps:
    - template: templates/e2e-setup.yaml

    # If edgeDaemonVersion != 'release/1.1', remove the iotedge and
    # libiothsm-std packages from $(System.ArtifactsDirectory) and download the desired
    # versions.  
    - bash: |
        if [ $(edgeDaemonVersion) != 'release/1.1' ]; then
          pushd $(System.ArtifactsDirectory)/$(artifactName)
          rm iotedge*.deb
          rm libiothsm-std*.deb
          apt-get download iotedge='$(edgeDaemonVersion)-1'
          apt-get download libiothsm-std='$(edgeDaemonVersion)-1'
          popd
        fi
      displayName: Replace Downloaded Edgelet Packages

    - bash: |
        echo "##vso[task.setvariable variable=updateRuntimeImages;]False"
        if [ '$(runtimeModulesVersion)' = 'main' ]; then
          echo "##vso[task.setvariable variable=updateRuntimeImages;]True"
        fi
        echo '$(updateRuntimeImages)'        
        echo "##vso[task.setvariable variable=updateBootstrapAgentImage;]False"
        if [ '$(bootstrapAgentVersion)' = 'main' ]; then
          echo "##vso[task.setvariable variable=updateBootstrapAgentImage;]True"
        fi
        echo '$(updateBootstrapAgentImage)'
      displayName: Set Boolean Variables (main)

    # If necessary, update context.json w/ image tag from main artifactInfo.txt
    - template: templates/upgrade-scenarios-setup.yaml
      parameters:
        useArtifactInfoFile: 'True'
        artifactBranch: 'main'
        updateRuntimeImages: '$(updateRuntimeImages)'
        updateBootstrapAgentImage: '$(updateBootstrapAgentImage)'
        project: $(resources.pipeline.images_main.projectID)
        pipeline: $(resources.pipeline.images_main.pipelineName)
        buildId: $(resources.pipeline.images_main.runID)

    - bash: |
        echo "##vso[task.setvariable variable=updateRuntimeImages;]False"
        if [ '$(runtimeModulesVersion)' = 'release/1.2' ]; then
          echo "##vso[task.setvariable variable=updateRuntimeImages;]True"
        fi
        echo '$(updateRuntimeImages)'        
        echo "##vso[task.setvariable variable=updateBootstrapAgentImage;]False"
        if [ '$(bootstrapAgentVersion)' = 'release/1.2' ]; then
          echo "##vso[task.setvariable variable=updateBootstrapAgentImage;]True"
        fi
        echo '$(updateBootstrapAgentImage)'
      displayName: Set Boolean Variables (release/1.2)

    # If necessary, update context.json w/ image tag from release/1.2 artifactInfo.txt
    - template: templates/upgrade-scenarios-setup.yaml
      parameters:
        useArtifactInfoFile: 'True'
        artifactBranch: 'release/1.2'
        updateRuntimeImages: '$(updateRuntimeImages)'
        updateBootstrapAgentImage: '$(updateBootstrapAgentImage)'
        project: $(resources.pipeline.images_release_1_2.projectID)
        pipeline: $(resources.pipeline.images_release_1_2.pipelineName)
        buildId: $(resources.pipeline.images_release_1_2.runID)

    - template: templates/e2e-run.yaml