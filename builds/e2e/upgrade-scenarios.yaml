trigger: none
pr: none

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'main'
    trigger:
      branches:
      - main
      # TODO: Uncomment and remove "main" when release/1.3 is created
      #- release/1.3
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: 'main'
    trigger:
      branches:
      - main
      # TODO: Uncomment and remove "main" when release/1.3 is created
      #- release/1.3

jobs:
################################################################################
  - job: partial_upgrade_ubuntu_1804_msmoby
################################################################################
    displayName: Partial Upgrade

    pool:
      name: $(pool.linux.name)
      demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-msmoby

    variables:
      os: linux
      arch: amd64
      artifactName: iotedged-ubuntu18.04-amd64
      identityServiceArtifactName: packages_ubuntu-18.04_amd64
      identityServicePackageFilter: aziot-identity-service_*_amd64.deb
      minimal: true
      verbose: false

    strategy:
      matrix:
        # Scenarios 1 to 5 test older versions of the bootstrap Edge Agent 
        # module with the main/1.3 Edge Daemon and Runtime Modules. These represent
        # scenarios where the Edge Daemon and Runtime Modules in the deployment 
        # are upgraded, but the bootstrap agent in config.toml/config.yaml is not.
        1.1.0_to_1.3_no_bootstrap_agent:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.0"
          runtimeModulesVersion: "main"
        1.1.8_to_1.3_no_bootstrap_agent:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.8"
          runtimeModulesVersion: "main"
        1.1.13_to_1.3_no_bootstrap_agent:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.13"
          runtimeModulesVersion: "main"
        1.2.0_to_1.3_no_bootstrap_agent:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.2.0"
          runtimeModulesVersion: "main"
        1.2.9_to_1.3_no_bootstrap_agent:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.2.9"
          runtimeModulesVersion: "main"

        # Scenarios 6 to 10 test the main/1.3 Edge Daemon with older versions of the 
        # bootstrap Edge Agent, and runtime modules. These represent scenarios where
        # the Edge Daemon is upgraded, but the config.toml/config.yaml and deployment 
        # are left using older runtime images.
        1.1.0_to_1.3_only_edge_daemon:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.0"
          runtimeModulesVersion: "1.1.0"
        1.1.8_to_1.3_only_edge_daemon:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.8"
          runtimeModulesVersion: "1.1.8"
        1.1.13_to_1.3_only_edge_daemon:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.1.13"
          runtimeModulesVersion: "1.1.13"
        1.2.0_to_1.3_only_edge_daemon:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.2.0"
          runtimeModulesVersion: "1.2.0"
        1.2.9_to_1.3_only_edge_daemon:
          edgeDaemonVersion: "main"
          bootstrapAgentVersion: "1.2.9"
          runtimeModulesVersion: "1.2.9"

    timeoutInMinutes: 90

    steps:
    - template: templates/e2e-setup.yaml

    # Run sed command on context.json to set edgeAgentBootstrapImage, edgeAgentImage, and edgeHubImage
    - bash: |
        cd $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/net*
        less context.json
        if [ $(runtimeModulesVersion) != "main" ]; then
          sed -i 's/"edgeAgentImage.*/"edgeAgentImage": "mcr.microsoft.com\/azureiotedge-agent:$(runtimeModulesVersion)",/' context.json
          sed -i 's/"edgeHubImage.*/"edgeHubImage": "mcr.microsoft.com\/azureiotedge-hub:$(runtimeModulesVersion)",/' context.json
        fi
        if [ $(bootstrapAgentVersion) != "main" ]; then
          sed -i 's/"edgeAgentBootstrapImage.*/"edgeAgentBootstrapImage": "mcr.microsoft.com\/azureiotedge-agent:$(bootstrapAgentVersion)",/' context.json
        fi
        less context.json

    - template: templates/e2e-run.yaml