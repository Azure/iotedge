trigger: none
pr: none

resources:
  pipelines:
  - pipeline: images
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.1'
    trigger:
      branches:
      - release/1.1
  - pipeline: packages
    source: 'Azure-IoT-Edge-Core Edgelet Packages'
    branch: 'release/1.1'
    trigger:
      branches:
      - release/1.1
  - pipeline: images_main
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'main'
  - pipeline: images_release_1_2
    source: 'Azure-IoT-Edge-Core Build Images'
    branch: 'release/1.2'    

jobs:
################################################################################
  - job: ubuntu_1804_msmoby
################################################################################
    displayName: Ubuntu 18.04 with iotedge-moby

    pool:
      name: $(pool.linux.name)
      demands:
      - ImageOverride -equals agent-aziotedge-ubuntu-18.04-msmoby

    variables:
      os: linux
      arch: amd64
      artifactName: iotedged-ubuntu18.04-amd64
      identityServiceArtifactName: packages_ubuntu-18.04_amd64
      identityServicePackageFilter: aziot-identity-service_*_amd64.deb
      minimal: true

    strategy:
      matrix:
        scenario_1:
          edgeDaemonVersion: "release/1.1"
          bootstrapAgentVersion: "main"
          runtimeModulesVersion: "main"
        scenario_2:
          edgeDaemonVersion: "release/1.1"
          bootstrapAgentVersion: "release/1.1"
          runtimeModulesVersion: "main"
        scenario_3:
          edgeDaemonVersion: "release/1.1"
          bootstrapAgentVersion: "release/1.2"
          runtimeModulesVersion: "release/1.2"
        scenario_4:
          edgeDaemonVersion: "release/1.1"
          bootstrapAgentVersion: "release/1.1"
          runtimeModulesVersion: "release/1.2"
        scenario_5:
          edgeDaemonVersion: "1.1.0"
          bootstrapAgentVersion: "main"
          runtimeModulesVersion: "main"
        scenario_6:
          edgeDaemonVersion: "1.1.0"
          bootstrapAgentVersion: "1.1.0"
          runtimeModulesVersion: "main"
        scenario_7:
          edgeDaemonVersion: "1.1.8"
          bootstrapAgentVersion: "main"
          runtimeModulesVersion: "main"
        scenario_8:
          edgeDaemonVersion: "1.1.8"
          bootstrapAgentVersion: "1.1.8"
          runtimeModulesVersion: "main"
        scenario_9:
          edgeDaemonVersion: "1.1.13"
          bootstrapAgentVersion: "main"
          runtimeModulesVersion: "main"
        scenario_10:
          edgeDaemonVersion: "1.1.13"
          bootstrapAgentVersion: "1.1.13"
          runtimeModulesVersion: "main"

    timeoutInMinutes: 90

    steps:
    - template: templates/e2e-setup.yaml

    # If edgeDaemonVersion != "release/1.1", remove the iotedge and
    # libiothsm-std packages from $(System.ArtifactsDirectory) and download the desired
    # versions.  
    - bash: |
        if [ $(edgeDaemonVersion) != "release/1.1" ]; then
          pushd $(System.ArtifactsDirectory)/$(artifactName)
          rm iotedge*.deb
          rm libiothsm-std*.deb
          apt-get download iotedge='$(edgeDaemonVersion)-1'
          apt-get download libiothsm-std='$(edgeDaemonVersion)-1'
          popd
        fi

    - task: DownloadBuildArtifacts@0
      displayName: Download Main Images
      inputs:
        buildType: specific
        project: $(resources.pipeline.images_main.projectID)
        pipeline: $(resources.pipeline.images_main.pipelineName)
        buildVersionToDownload: specific
        buildId: $(resources.pipeline.images_main.runID)
        downloadType: single
        artifactName: $(az.pipeline.images.artifacts)
        itemPattern: $(az.pipeline.images.artifacts)/artifactInfo.txt

    # If $runtimeModulesVersion or $bootstrapAgentVersion is set to 'main', retrieve
    # image ID from artifactInfo.txt and update context.json with it.
    - bash: |
        artifactInfoStr=`cat '$(System.ArtifactsDirectory)/$(az.pipeline.images.artifacts)/artifactInfo.txt'`
        IFS='='
        read -ra artifactInfo <<< "$artifactInfoStr"
        imageId="${artifactInfo[1]}"
        cd $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/net*
        less context.json
        if [ $(runtimeModulesVersion) = "main" ]; then
          sed -i 's/"edgeAgentImage.*/"edgeAgentImage": "mcr.microsoft.com\/azureiotedge-agent:$imageId",/' context.json
          sed -i 's/"edgeHubImage.*/"edgeHubImage": "mcr.microsoft.com\/azureiotedge-hub:$imageId",/' context.json
        fi
        if [ $(bootstrapAgentVersion) = "main" ]; then
          sed -i 's/"edgeAgentBootstrapImage.*/"edgeAgentBootstrapImage": "mcr.microsoft.com\/azureiotedge-agent:$imageId",/' context.json
        fi
        less context.json

    - task: DownloadBuildArtifacts@0
      displayName: Download Release/1.2 Images
      inputs:
        buildType: specific
        project: $(resources.pipeline.images_release_1_2.projectID)
        pipeline: $(resources.pipeline.images_release_1_2.pipelineName)
        buildVersionToDownload: specific
        buildId: $(resources.pipeline.images_release_1_2.runID)
        downloadType: single
        artifactName: $(az.pipeline.images.artifacts)
        itemPattern: $(az.pipeline.images.artifacts)/artifactInfo.txt

    # If $runtimeModulesVersion or $bootstrapAgentVersion is set to 'release/1.2', retrieve
    # image ID from artifactInfo.txt and update context.json with it.
    - bash: |
        artifactInfoStr=`cat '$(System.ArtifactsDirectory)/$(az.pipeline.images.artifacts)/artifactInfo.txt'`
        IFS='='
        read -ra artifactInfo <<< "$artifactInfoStr"
        imageId="${artifactInfo[1]}"
        cd $(Build.SourcesDirectory)/test/Microsoft.Azure.Devices.Edge.Test/bin/Debug/net*
        less context.json
        if [ $(runtimeModulesVersion) = "release/1.2" ]; then
          sed -i 's/"edgeAgentImage.*/"edgeAgentImage": "mcr.microsoft.com\/azureiotedge-agent:$imageId",/' context.json
          sed -i 's/"edgeHubImage.*/"edgeHubImage": "mcr.microsoft.com\/azureiotedge-hub:$imageId",/' context.json
        fi
        if [ $(bootstrapAgentVersion) = "release/1.2" ]; then
          sed -i 's/"edgeAgentBootstrapImage.*/"edgeAgentBootstrapImage": "mcr.microsoft.com\/azureiotedge-agent:$imageId",/' context.json
        fi
        less context.json        

    - template: templates/e2e-run.yaml