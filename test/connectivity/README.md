 Connectivity tests

![Connectivity Test Diagram](./images/ConnectivityTestDiagram.png)

### Test Scenarios
These are test scenarios to be covered in Connectivity test

1. Messaging Test
   1. Module-to-Module
   2. Module-to-IoT Hub
2. Twin Property Update Test
   1. Desired property
   2. Reported property
3. Direct Method Test
   1. Cloud-to-module
   2. Ping method in EdgeAgent
4. EdgeAgent Deployment Test
   1. Deployment change
5. EdgeHub Restart Test
   1. Message Test
   2. Direct Method Test

### General flow
1. Currently Connectivity test is supported only to run on Linux AMD64.
2. Connectivity test can be run by calling [Connectivity Test script](https://github.com/Azure/iotedge/blob/master/test/connectivity/scripts/connectivityTest.sh).
3. Each test runs using AMQP and MQTT TCP protocol.
4. For each run, a new tracking id (Guid) is generated by the test script.
5. Test starts after pre-defined warm-up period (default 2 minutes), which assumes EdgeHub and other modules containers are up and running.
6. A test duration is configurable and is set to 1 hour by default.
7. A test module is responsible for providing the Test Result Coordinator with a result of its operation.
8. An operation result is persistently stored by the Test Result Coordinator after validating result type is supported.
9. The Test Result Coordinator consumes events from IoT hub's built-in event hub endpoint for messaging scenario verification.
10. The Network Controller simulates a different test network condition, e.g. offline or packet loss. The Network Controller, like any other test modules, is responsible to report a result of its action to The Test Result Coordinator.
11. After the test duration is over, the test waits for a brief period of time to ensure that all of the actions propagated through the system. Then, the final test report is generated and uploaded to Log Analytics. The buffer is 15 minutes by default, which assumes all messages are received on IoT hub and are pulled for verification.
12. After test duration, test modules should stop calling operations, e.g. sending messages, making Direct method calls, etc.

### Offline Scenario
1. The Network Controller controls the virtual network "Azure-IoT-Edge" to simulate offline and packet-loss scenarios.
2. When generating test result reports, network status is taken into consideration based on result reported by Network controller.

### Potential Issues
1. If there are many tests running at the same time using devices in the same IoT hub, there may be too many event messages received by Test Result Coordinator; which slows down test result verification and may cause failed result.
   1. Try to reduce number of test devices in a test IoT hub.
   2. Introduce Azure Stream Analytics (ASA) to process messages, which should provide a higher throughput.
2. Network Controller implementation may support on Linux only, but not Windows platform.

### Tests

#### Messaging Test

![Connectivity Test Diagram](./images/ConnectivityTest_Messaging.png)

##### Test Specific Components:
	1. Message Sender (loadGen) is a module client that is deployed into a test agent as a container module. The responsibility of the module is to send a message to another module along with reporting to Test Result Coordinator once a message is sent. 
	2. Message Receiver (Relayer) is a module client that is a receiver of the message sending from the Message Sender. Once the message is received, the Message Receiver notifies the Test Result Coordinator regarding the message arrival.

##### Test Mechanism: 
	1. loadGen starts sending messages after pre-defined warm-up period.
	2. loadGen sends module-to-module messages to Relayer through Edge hub (#1 -> Edge hub -> #2).
	3. After sending each message, loadGen reports result to Test Result Coordinator (#3).
	4. Relayer receives the message and reports result to Test Result Coordinator (#2 -> #4).
	5. After receiving in Relayer, messages send forward to IoT hub through Edge hub (#5 -> Edge hub -> #7).
	6. After forwading each message in relayer, it reports result to Test Result Coordinator (#6).
	7. All messages should contain tracking id, batch id and sequence number.  Sequence number should always start at 1 in loadGen.

Network offline/online should not affect this test result since Edge hub stores all messages when offline and resumes back once get back online.

#### Deployment Update Test

![Connectivity Test Diagram](./images/ConnectivityTest_DeploymentUpdate.png)

1. DeploymentTester1 is in host network, while DeploymentTester2 is in Azure-IoT-Edge docker network.
2. DeploymentTester1 starts updating target module (DeploymentTester2) deployment by adding new environment variables after pre-defined warm-up period.
3. DeploymentTester1 sends updated deployment of DeploymentTester2 to IoT hub (#1).
4. After updating target module deployment, DeploymentTester1 will report result to Test Result Coordinator (#2).
5. Edge Agent will get updated deployment of target module from IoT hub (#3); and deploy module with updated environment variables (#4).
6. When DeploymentTester2 starts up, it will get all environment variables and report to Test Result Coordinator (#5).

When network goes offline, route#3 will not happen.  But once the network comes back online, Edge Agent should be able to get the latest updated deployment and deploy DeploymentTester2.

#### Cloud to Module Direct Method Test

![Connectivity Test Diagram](./images/ConnectivityTest_C2M_DirectMethod.png)

The Direct Method Connectivity Test is designed to test direct method resilience against network connectivity issue. 
##### Test Specific Component:
	1. Direct Method (Cloud) Sender is an Azure service client that is wrapped in a container module that is deployed into a test agent.  It is responsible for sending a "HelloWorldMethod" direct method to the Direct Method Receiver module and report the direct method status to Test Result Coordinator.
	2. Direct Method Receiver is a module container that runs a module client that is deployed into a test agent. It is a targeted receiver of Direct Method Sender. It is responsible for replying to the "HelloWorldMethod" direct method and notify Test Result Coordinate if it receives a direct method.

##### Test Mechanism: 
	1. The Direct Method (Cloud) Sender invokes a test direct method to the IoT Hub.
	2. The IoT Hub forwards the direct method to Edge Hub.
	3. The Edge Hub forwards the direct method to Direct Method Receiver.
	4. The Direct Method Receiver notifies Test Result Coordinator regarding the received direct method.
	5. The Direct Method Receiver responds to Edge Hub's direct method invocation.
	6. The Edge Hub responds to IoT Hub direct method invocation.
	7. The Direct Method (Cloud) Sender receives a response from IoT Hub.
	8. The Direct Method (Cloud) Sender notifies Test Result Coordinator regarding its direct method response.
	9. Test Result Coordinator compiles a report from Direct Method (Cloud) Sender, Direct Method Receiver, Network Controller and determine if the test case is passed or failed. 

##### Passing Criteria: 
TBD

#### Cloud to EdgeAgent Direct Method Test (PING)

![Connectivity Test Diagram](./images/ConnectivityTest_Ping_DirectMethod.png)

##### Test Specific Component:
	1. Direct Method (Cloud) Sender is an Azure service client that is wrapped in a container module that is deployed into a test agent.  It is responsible for sending a "HelloWorldMethod" direct method to the EdgeAgent module and report the direct method status to Test Result Coordinator.

##### Test Mechanism: 
	1. The Direct Method Cloud Sender invokes a test direct method to the IoT Hub.
	2. The IoT Hub forwards the direct method to Edge Agent.
	3. The Edge Agent has a pre-implemented "ping" method with a response.
	4. The Direct Method Cloud Sender receives a response from IoT Hub.
	5. The Direct Method Cloud Sender notifies Test Result Coordinator regarding its direct method response.
	6. Test Result Coordinator compiles a report from Direct Method Cloud Sender, Direct Method Receiver, Network Controller and determine if the test case is passed or failed. 

##### Passing Criteria: 
TBD

#### Cloud to Device Message Test

![Connectivity Test Diagram](./images/ConnectivityTest_C2D_Message.png)

The goal of the test scheme is to verify the recoverability of the cloud to device messaging once the device goes offline. 
##### Test Specific Components:
	1. Message Sender is an Azure service client that is deployed into a test agent as a container module. The responsibility of the module is to use the Azure API to trigger IoT Hub to send a message to device along with reporting to Test Result Coordinator once a message is sent. 
	2. Message Receiver is a device client that is wrapped in a module container for a deployment into a test agent. The device module behaves as a target receiver of the message sending from Message (Cloud) Sender and is responsible for reporting to the Test Result Coordinator once a message is received.

##### Test Implementation Assumption:
	1. The cloud takes less than 15 minutes to forward all of messages from the cloud to device when the Edge Hub is online.
	2. Each cycle of Network Controller online-offline period must be longer than the Edge Hub recovering period.
	3. Since the Message Sender uses service client to send a message to the cloud from the host network, it will always report success even if the message has yet gotten to the Message Receiver. If the Message Sender fails to send a message, the message sequencing ID should NOT be increased; instead, a failed message with the same sequence number should be resent.
		a. Implementation Note: The sequence number is not increased in case of failure makes the verification process easier by solely verify the message sequence number is sequential.
		b. Implementation Note: Generally if there is a failure (or an exception) from message sending, the error information is logged in the Message Sender log.
	
##### Test Mechanism: 
	1. The Message Sender invokes the IoT Hub to send a message to a targeted device.
	2. The Message Sender notify the Test Result Coordinator that a message has been sent.
	3. The IoT Hub sends a message to Edge Hub addressing a targeted device.
	4. The Edge Hub forward the message to a Message Receiver device module.
	5. The Message Receiver notifies that the message successfully received to the Test Result Coordinator.
	6. The Message Receiver replies that the message successfully received to the Edge Hub.
	7. The Edge Hub forward the Message Receiver's response back to IoT Hub.
	8. The IoT Hub forward the response to Message Sender.

##### Passing Criteria: 
All the messages sent by Message Sender is received in order at Message Receiver within (EdgeHub_Recover_Time) + 15 minutes.
Where (EdgeHub_Recover_Time) is the time span EdgeHub takes to be aware of online/offline state

#### EdgeHub Restart Test
The goal of EdgeHub Restart Test is to verify/benchmark a restart period of an EdgeHub. The measurement is done using two methods: a Direct Method and a Message.

The message test is developed to strictly test only when the EdgeHub complete its restart and is ready for a module to connect.  While the direct method test also make sure that the receiver can successfully response to the direct method request from the sender. This results in a slightly different time measurement between the two test (see the diagram below).

![Connectivity Test Diagram](./images/ConnectivityTest_EdgeHubRestart_Timeline.png)

##### EdgeHub Restart Test : Message Test

![Connectivity Test Diagram](./images/ConnectivityTest_EdgeHubRestart_Message.png)

###### Test Specific Components:
	1. EdgeHub Restart Tester (EHRT) has two responsibility including
		a. Restart EdgeHub - The EHRT sends a direct method via service client to edgeAgent informing that edgeHub needs to be restart.
		b. Send a message via EdgeHub - The EHRT will attempt to send message via EdgeHub to the Message Receiver (relayer) once the restart direct method is successfully issued.
		Note: EHRT and EdgeAgent are deployed in Host Network scope because it is crucial to test that the Restart Direct Method to always succeed via IoTHub even in the offline scenario.
	2. Message Receiver is a target for EHRT to send a message. Once the message is received in the Message Receiver, it will forward the message to Test Result Coordinator for a verification.

###### Test Mechanism: 
	1. The EdgeHub Restart Tester issues a direct method to EdgeAgent notifying the EdgeAgent to restart EdgeHub module.
	2. Once the restart direct method response with a success, the EdgeHub Restart Tester attempts to send a message to Message Receiver via EdgeHub. 
		a. The SDK will throw an exception within EdgeHub Restart Tester if the EdgeHub is unabled to be connected
		b. If the SDK stops throwing an exception and respond with HTTP OK, it is an indicator that the sender module is able to communicate with EdgeHub. However, this does not imply that the EdgeHub can successfully send the message to the Message Receiver.
	3. The EdgeHub Restart Tester reports its related results to the Test Result Coordinator.
	4. Eventually the EdgeHub will forward the message to the Message Receiver once the receiver module can successfully reconnected to the EdgeHub.
	5. Once the receiver module receives a message, it will report the message receival to Test Result Coordinator.

###### Passing Criteria:
	1. The EdgeHub module can successfully be restarted by the EdgeHub Restart Tester.
	2. The EdgeHub Restart Tester can successfully send a message to Edge Hub within the configured restart period.
	3. The Message Receiver receives a message from EdgeHub Restart Tester that is routed via EdgeHub within a reasonable timely fashion.

##### EdgeHub Restart Test : Direct Method Test

![Connectivity Test Diagram](./images/ConnectivityTest_EdgeHubRestart_DirectMethod.png)


###### Test Specific Components:
	1. EdgeHub Restart Tester (EHRT) has two responsibility including
		a. Restart EdgeHub - The EHRT sends a direct method via service client to edgeAgent informing that edgeHub needs to be restart.
		b. Send a direct method via EdgeHub - The EHRT will attempt to send direct method (via EdgeHub) to the Direct Method Receiver once the restart direct method is successfully issued.
		Note: EHRT and EdgeAgent are deployed in Host Network scope because it is crucial to test that the Restart Direct Method to always succeed via IoTHub even in the offline scenario. 
	2. Direct Method Receiver is a target for EHRT to send a direct method. Once the Direct Method is received, the Receiver immediately report the direct method receival to Test Result Coordinator for a verification.

###### Test Mechanism: 
	1. The EdgeHub Restart Tester issues a direct method to EdgeAgent notifying the EdgeAgent to restart EdgeHub module.
	2. Once the restart direct method response with a success, the EdgeHub Restart Tester attempts to send a Direct Method to the Direct Method Receiver. 
		a. The SDK will throw an exception within EdgeHub Restart Tester if the EdgeHub is unabled to be connected OR the receiver module is unabled to be connected.
		b. If the SDK stops throwing an exception and respond with HTTP OK, it is an indicator that the EdgeHub Restarter Tester module is able to communicate with Direct Method Receiver successfully. This ensures by the SDK that the Direct Method Receiver received the direct method.
	3. Upon the receival of the direct method, the Direct Method Receiver sends a result to the Test Result Coordinator.
	4. After the Direct Method Receiver responses, the EdgeHub Restart Tester sends the response result to the Test Result Coordinator.

###### Passing Criteria:
	1. The EdgeHub module can successfully be restarted by the EdgeHub Restart Tester.
	2. The EdgeHub Restart Tester can successfully send a direct method to Direct Method Receiver within the configured restart period.